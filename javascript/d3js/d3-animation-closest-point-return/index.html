<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.21.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Creating an animation with d3.js - Parresia Simulations</title>
<meta name="description" content="How the closest-point return animation was created">


  <meta name="author" content="Biswajit Banerjee">
  
  <meta property="article:author" content="Biswajit Banerjee">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Parresia Simulations">
<meta property="og:title" content="Creating an animation with d3.js">
<meta property="og:url" content="https://bbanerjee.github.io/ParSim/javascript/d3js/d3-animation-closest-point-return/">


  <meta property="og:description" content="How the closest-point return animation was created">







  <meta property="article:published_time" content="2017-04-01T23:30:00+13:00">





  

  


<link rel="canonical" href="https://bbanerjee.github.io/ParSim/javascript/d3js/d3-animation-closest-point-return/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Biswajit Banerjee",
      "url": "https://bbanerjee.github.io/ParSim/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/ParSim/feed.xml" type="application/atom+xml" rel="alternate" title="Parresia Simulations Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/ParSim/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<link rel="stylesheet" href="https://bbanerjee.github.io/ParSim/assets/css/parresia.css">

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_HTMLorMML">
  </script>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/ParSim/"><img src="/ParSim/assets/img/ParresiaLogoSep2017_plain.png" alt=""></a>
        
        <a class="site-title" href="/ParSim/">
          Parresia Simulations
          <span class="site-subtitle">Parallel particle and finite element simulation</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/ParSim/docs/articles/">Blog articles</a>
            </li><li class="masthead__menu-item">
              <a href="/ParSim/docs/parsim/">ParSim software</a>
            </li><li class="masthead__menu-item">
              <a href="/ParSim/docs/material-data/">Material data</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Biswajit Banerjee</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>PhD Mechanical Engineering</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Auckland, NZ</span>
        </li>
      

      
        
          
            <li><a href="mailto:b.banerjee.nz@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Creating an animation with d3.js">
    <meta itemprop="description" content="IntroductionIn Part 8 of theseries on return algorithms for plasticity we animated the closest-point return algorithm asshown below.">
    <meta itemprop="datePublished" content="2017-04-01T23:30:00+13:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Creating an animation with d3.js
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          54 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#generating-points-on-the-yield-surface">Generating points on the yield surface</a></li>
  <li><a href="#drawing-the-yield-surface-and-closest-point-projection">Drawing the yield surface and closest-point projection</a>
    <ul>
      <li><a href="#creating-the-svg">Creating the SVG</a></li>
      <li><a href="#creating-the-canvas-group">Creating the canvas group</a></li>
      <li><a href="#creating-map-from-real-to-canvas-coordinates">Creating map from real to canvas coordinates</a></li>
      <li><a href="#creating-svg-polyline-generator">Creating SVG polyline generator</a></li>
      <li><a href="#creating-the-axes-and-the-yield-surface">Creating the axes and the yield surface</a></li>
      <li><a href="#creating-groups-for-each-iteration">Creating groups for each iteration</a></li>
      <li><a href="#adding-circles-to-the-approximate-surface">Adding circles to the approximate surface</a></li>
      <li><a href="#adding-triangles-to-the-projection-line">Adding triangles to the projection line</a></li>
      <li><a href="#setting-up-the-animation">Setting up the animation</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h5 id="introduction">Introduction</h5>
<p>In <a href="/ParSim/mechanics/plasticity/algorithm/geometric-closest-point-return/">Part 8</a> of the
series on return algorithms for plasticity we animated the closest-point return algorithm as
shown below.
<!--more--></p>

<div class="yield-surf-canvas">
</div>

<p>An animated GIF of the plot can be generated using the following <code class="language-plaintext highlighter-rouge">R</code> script.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">require</span><span class="p">(</span><span class="s2">"ggplot2"</span><span class="p">)</span><span class="w">
</span><span class="n">require</span><span class="p">(</span><span class="s2">"animation"</span><span class="p">)</span><span class="w">
</span><span class="n">require</span><span class="p">(</span><span class="s2">"latex2exp"</span><span class="p">)</span><span class="w">

</span><span class="c1">#------------------------------------------------------</span><span class="w">
</span><span class="c1"># Plot single iteration</span><span class="w">
</span><span class="c1">#------------------------------------------------------</span><span class="w">
</span><span class="n">plotYieldSurface</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">zrprime_data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">

  </span><span class="n">zrprime_trial_closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zrprime_data</span><span class="p">[</span><span class="n">which</span><span class="p">(</span><span class="n">zrprime_data</span><span class="o">$</span><span class="n">Label</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"trial"</span><span class="w"> </span><span class="o">|</span><span class="w">
                                             </span><span class="n">zrprime_data</span><span class="o">$</span><span class="n">Label</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"closest"</span><span class="p">),]</span><span class="w">
  </span><span class="n">plt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
        </span><span class="n">geom_path</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zrprime_data</span><span class="p">,</span><span class="w"> 
                  </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="m">1.0e-6</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rprime</span><span class="o">*</span><span class="m">1.0e-6</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">Label</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Label</span><span class="p">),</span><span class="w">
                      </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="o">+</span><span class="w">
        </span><span class="n">geom_point</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zrprime_data</span><span class="p">,</span><span class="w"> 
                   </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="m">1.0e-6</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rprime</span><span class="o">*</span><span class="m">1.0e-6</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="o">=</span><span class="n">Label</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Label</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
        </span><span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zrprime_trial_closest</span><span class="p">,</span><span class="w">
                  </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="m">1.0e-6</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rprime</span><span class="o">*</span><span class="m">1.0e-6</span><span class="p">),</span><span class="w">
                  </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="n">linetype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
                  </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w">
        </span><span class="n">xlab</span><span class="p">(</span><span class="n">TeX</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">"$z = I_1/\\sqrt{3}$"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MPa"</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w">
        </span><span class="n">ylab</span><span class="p">(</span><span class="n">TeX</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">"$r' = \\beta\\sqrt{3K/2G}\\sqrt{2J_2}$"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MPa"</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w">
        </span><span class="n">coord_fixed</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w">
        </span><span class="n">theme_bw</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> 
        </span><span class="n">theme</span><span class="p">(</span><span class="n">legend.justification</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">legend.position</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="w">
            </span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">14</span><span class="p">),</span><span class="w">
            </span><span class="n">axis.title.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">16</span><span class="p">),</span><span class="w">
            </span><span class="n">axis.title.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">16</span><span class="p">),</span><span class="w">
            </span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">14</span><span class="p">),</span><span class="w">
            </span><span class="n">axis.text.y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">14</span><span class="p">),</span><span class="w">
            </span><span class="n">legend.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">))</span><span class="w">
  </span><span class="n">print</span><span class="p">(</span><span class="n">plt</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">#------------------------------------------------------</span><span class="w">
</span><span class="c1"># Animate the plots</span><span class="w">
</span><span class="c1">#------------------------------------------------------</span><span class="w">
</span><span class="n">animateIterations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">yieldSurfData</span><span class="p">,</span><span class="w"> </span><span class="n">num_iterations</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">lapply</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">num_iterations</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> 
         </span><span class="k">function</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
           </span><span class="n">plotYieldSurface</span><span class="p">(</span><span class="n">extractIteration</span><span class="p">(</span><span class="n">yieldSurfData</span><span class="p">,</span><span class="w"> </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">))</span><span class="w">
         </span><span class="p">})</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">#------------------------------------------------------</span><span class="w">
</span><span class="c1"># Function to create animated gif</span><span class="w">
</span><span class="c1">#------------------------------------------------------</span><span class="w">
</span><span class="n">createGIFIterations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">yieldSurfData</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">

  </span><span class="n">outputGIFFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"closest_point_iter"</span><span class="p">,</span><span class="w"> </span><span class="s2">".gif"</span><span class="p">)</span><span class="w">

  </span><span class="c1"># Compute number of iterations</span><span class="w">
  </span><span class="n">num_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">yieldSurfData</span><span class="o">$</span><span class="n">Iteration</span><span class="p">))</span><span class="w">

  </span><span class="c1"># Save as animation</span><span class="w">
  </span><span class="n">ani.options</span><span class="p">(</span><span class="n">ani.height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">600</span><span class="p">,</span><span class="w"> </span><span class="n">ani.width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">600</span><span class="p">)</span><span class="w">
  </span><span class="n">saveGIF</span><span class="p">(</span><span class="n">animateIterations</span><span class="p">(</span><span class="n">yieldSurfData</span><span class="p">,</span><span class="w"> </span><span class="n">num_iterations</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">),</span><span class="w"> 
          </span><span class="n">interval</span><span class="o">=</span><span class="m">1.0</span><span class="p">,</span><span class="w"> 
          </span><span class="n">movie.name</span><span class="o">=</span><span class="n">outputGIFFile</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">#-------------------------------------------------------------------------</span><span class="w">
</span><span class="c1"># Compute the full yield surface and create data frame</span><span class="w">
</span><span class="c1">#-------------------------------------------------------------------------</span><span class="w">
</span><span class="n">ComputeFullYieldSurface</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">,</span><span class="w"> </span><span class="n">capX</span><span class="p">,</span><span class="w"> </span><span class="n">pbar_w</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">num_points</span><span class="p">,</span><span class="w">
                                    </span><span class="n">z_r_pt</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w">
                                    </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">

  </span><span class="c1"># Get yield parameters</span><span class="w">
  </span><span class="n">yieldParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unlist</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">)</span><span class="w">
  </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">[</span><span class="s1">'PEAKI1'</span><span class="p">])</span><span class="w">
  </span><span class="n">FSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">[</span><span class="s1">'FSLOPE'</span><span class="p">])</span><span class="w">
  </span><span class="n">STREN</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">[</span><span class="s1">'STREN'</span><span class="p">])</span><span class="w">
  </span><span class="n">YSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">[</span><span class="s1">'YSLOPE'</span><span class="p">])</span><span class="w">
  </span><span class="n">CR</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">[</span><span class="s1">'CR'</span><span class="p">])</span><span class="w">

  </span><span class="c1"># Set up constants</span><span class="w">
  </span><span class="n">a1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STREN</span><span class="w">
  </span><span class="n">a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">FSLOPE</span><span class="o">-</span><span class="n">YSLOPE</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">STREN</span><span class="o">-</span><span class="n">YSLOPE</span><span class="o">*</span><span class="n">PEAKI1</span><span class="p">)</span><span class="w">
  </span><span class="n">a3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">STREN</span><span class="o">-</span><span class="n">YSLOPE</span><span class="o">*</span><span class="n">PEAKI1</span><span class="p">)</span><span class="o">*</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a2</span><span class="o">*</span><span class="n">PEAKI1</span><span class="p">)</span><span class="w">
  </span><span class="n">a4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">YSLOPE</span><span class="w">

  </span><span class="c1"># Compute kappa</span><span class="w">
  </span><span class="n">X_eff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">capX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">3</span><span class="o">*</span><span class="n">pbar_w</span><span class="w">
  </span><span class="n">kappa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">CR</span><span class="o">*</span><span class="p">(</span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">X_eff</span><span class="p">)</span><span class="w">

  </span><span class="c1"># Create an array of I1_eff values</span><span class="w">
  </span><span class="n">I1eff_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X_eff</span><span class="p">;</span><span class="w">
  </span><span class="n">I1eff_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PEAKI1</span><span class="p">;</span><span class="w">

  </span><span class="n">rad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">X_eff</span><span class="p">)</span><span class="w">
  </span><span class="n">cen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">X_eff</span><span class="p">)</span><span class="w">
  </span><span class="n">theta_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">acos</span><span class="p">(</span><span class="nf">max</span><span class="p">((</span><span class="n">I1eff_min</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cen</span><span class="p">)</span><span class="o">/</span><span class="n">rad</span><span class="p">,</span><span class="w"> </span><span class="m">-1.0</span><span class="p">))</span><span class="w">
  </span><span class="n">theta_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">acos</span><span class="p">(</span><span class="nf">min</span><span class="p">((</span><span class="n">I1eff_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cen</span><span class="p">)</span><span class="o">/</span><span class="n">rad</span><span class="p">,</span><span class="w"> </span><span class="m">1.0</span><span class="p">))</span><span class="w">
  </span><span class="n">theta_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">theta_min</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">theta_max</span><span class="p">,</span><span class="w"> </span><span class="n">length.out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_points</span><span class="p">)</span><span class="w">
  </span><span class="n">I1_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cen</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rad</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">theta_vec</span><span class="p">)</span><span class="w">
  </span><span class="n">I1_eff_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lapply</span><span class="p">(</span><span class="n">I1_list</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nf">max</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">X_eff</span><span class="p">)})</span><span class="w">
  </span><span class="n">sqrtJ2_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lapply</span><span class="p">(</span><span class="n">I1_eff_list</span><span class="p">,</span><span class="w">
    </span><span class="k">function</span><span class="p">(</span><span class="n">I1_eff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="c1"># Compute F_f</span><span class="w">
      </span><span class="n">Ff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a3</span><span class="o">*</span><span class="nf">exp</span><span class="p">(</span><span class="n">a2</span><span class="o">*</span><span class="n">I1_eff</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">a4</span><span class="o">*</span><span class="p">(</span><span class="n">I1_eff</span><span class="p">)</span><span class="w">

      </span><span class="c1"># Compute Fc</span><span class="w">
      </span><span class="n">Fc_sq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.0</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">I1_eff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kappa</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">X_eff</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">I1_eff</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">kappa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">I1_eff</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">kappa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">X_eff</span><span class="p">)</span><span class="w">
        </span><span class="n">Fc_sq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ratio</span><span class="o">^</span><span class="m">2</span><span class="w">
      </span><span class="p">}</span><span class="w">

      </span><span class="c1"># Compute sqrt(J2)</span><span class="w">
      </span><span class="n">sqrtJ2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Ff</span><span class="o">*</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">Fc_sq</span><span class="p">)</span><span class="w">
      </span><span class="nf">return</span><span class="p">(</span><span class="n">sqrtJ2</span><span class="p">)</span><span class="w">
    </span><span class="p">})</span><span class="w">
  </span><span class="n">zrprime_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unlist</span><span class="p">(</span><span class="n">I1_eff_list</span><span class="p">)</span><span class="o">/</span><span class="nf">sqrt</span><span class="p">(</span><span class="m">3</span><span class="p">),</span><span class="w"> 
                            </span><span class="n">rprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unlist</span><span class="p">(</span><span class="n">sqrtJ2_list</span><span class="p">)</span><span class="o">*</span><span class="nf">sqrt</span><span class="p">(</span><span class="m">2</span><span class="p">)</span><span class="o">*</span><span class="nf">sqrt</span><span class="p">(</span><span class="m">1.5</span><span class="o">*</span><span class="n">K</span><span class="o">/</span><span class="n">G</span><span class="p">),</span><span class="w"> 
                            </span><span class="n">Iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">iteration</span><span class="p">),</span><span class="w">
                            </span><span class="n">CIteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">consistency_iter</span><span class="p">),</span><span class="w">
                            </span><span class="n">Label</span><span class="o">=</span><span class="s2">"yield"</span><span class="p">)</span><span class="w">
  </span><span class="n">zrprime_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zrprime_data</span><span class="p">,</span><span class="w">
                       </span><span class="n">data.frame</span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z_r_pt</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">rprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z_r_pt</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> 
                                  </span><span class="n">Iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">iteration</span><span class="p">),</span><span class="w">
                                  </span><span class="n">CIteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">consistency_iter</span><span class="p">),</span><span class="w">
                                  </span><span class="n">Label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"trial"</span><span class="p">))</span><span class="w">
  </span><span class="n">zrprime_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zrprime_data</span><span class="p">,</span><span class="w">
                       </span><span class="n">data.frame</span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">rprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w"> 
                                  </span><span class="n">Iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">iteration</span><span class="p">),</span><span class="w">
                                  </span><span class="n">CIteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">consistency_iter</span><span class="p">),</span><span class="w">
                                  </span><span class="n">Label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"closest"</span><span class="p">))</span><span class="w">
  </span><span class="n">zrprime_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zrprime_data</span><span class="p">,</span><span class="w">
                       </span><span class="n">data.frame</span><span class="p">(</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">rprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w"> 
                                  </span><span class="n">Iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">iteration</span><span class="p">),</span><span class="w">
                                  </span><span class="n">CIteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">consistency_iter</span><span class="p">),</span><span class="w">
                                  </span><span class="n">Label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"polyline"</span><span class="p">))</span><span class="w">
 
  </span><span class="nf">return</span><span class="p">(</span><span class="n">zrprime_data</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">#-------------------------------------------------------------------------</span><span class="w">
</span><span class="c1"># Read data and plot for animation</span><span class="w">
</span><span class="c1">#-------------------------------------------------------------------------</span><span class="w">
</span><span class="n">ReadAndPlotClosestPoint</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">()</span><span class="w"> </span><span class="p">{)</span><span class="w">

  </span><span class="n">num_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="w">
  </span><span class="n">consistency_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w">

  </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w">
  </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3.98447e+07</span><span class="w">
  </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.32816e+07</span><span class="w">
  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1.87891e+07</span><span class="w">
  </span><span class="n">pbar_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5.24774e+06</span><span class="w">
  </span><span class="n">yieldParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">BETA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">CR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">FSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.355309</span><span class="p">,</span><span class="w"> </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">996.118</span><span class="p">,</span><span class="w"> </span><span class="n">STREN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.76382e+07</span><span class="p">,</span><span class="w"> </span><span class="n">YSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.353622</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">52172.3</span><span class="p">,</span><span class="m">3.60195e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.15079e+06</span><span class="p">,</span><span class="m">2.02165e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">575.109</span><span class="p">,</span><span class="m">-167406</span><span class="p">,</span><span class="m">-607187</span><span class="p">,</span><span class="m">-1.15079e+06</span><span class="p">,</span><span class="m">-1.59057e+06</span><span class="p">,</span><span class="m">-1.75855e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2.45257e-09</span><span class="p">,</span><span class="m">310133</span><span class="p">,</span><span class="m">1.12207e+06</span><span class="p">,</span><span class="m">2.02165e+06</span><span class="p">,</span><span class="m">1.72669e+06</span><span class="p">,</span><span class="m">0</span><span class="p">)</span><span class="w">
  </span><span class="n">zr_df</span><span class="w"> </span><span class="o">=</span><span class="w"> 
  </span><span class="n">ComputeFullYieldSurface</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">pbar_w</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">num_points</span><span class="p">,</span><span class="w">
                          </span><span class="n">z_r_pt</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w">
                          </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">)</span><span class="w">
  </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="w">
  </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3.98447e+07</span><span class="w">
  </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.32816e+07</span><span class="w">
  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1.87891e+07</span><span class="w">
  </span><span class="n">pbar_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5.24774e+06</span><span class="w">
  </span><span class="n">yieldParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">BETA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">CR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">FSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.355309</span><span class="p">,</span><span class="w"> </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">996.118</span><span class="p">,</span><span class="w"> </span><span class="n">STREN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.76382e+07</span><span class="p">,</span><span class="w"> </span><span class="n">YSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.353622</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">52172.3</span><span class="p">,</span><span class="m">3.60195e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.15079e+06</span><span class="p">,</span><span class="m">2.02165e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-878986</span><span class="p">,</span><span class="m">-1.15079e+06</span><span class="p">,</span><span class="m">-1.39598e+06</span><span class="p">,</span><span class="m">-1.59057e+06</span><span class="p">,</span><span class="m">-1.7155e+06</span><span class="p">,</span><span class="m">-1.75855e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1.62388e+06</span><span class="p">,</span><span class="m">2.02165e+06</span><span class="p">,</span><span class="m">2.08595e+06</span><span class="p">,</span><span class="m">1.72669e+06</span><span class="p">,</span><span class="m">979052</span><span class="p">,</span><span class="m">0</span><span class="p">)</span><span class="w">
  </span><span class="n">zr_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zr_df</span><span class="p">,</span><span class="w">
  </span><span class="n">ComputeFullYieldSurface</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">pbar_w</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">num_points</span><span class="p">,</span><span class="w">
                          </span><span class="n">z_r_pt</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w">
                          </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">))</span><span class="w">
  </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="w">
  </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3.98447e+07</span><span class="w">
  </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.32816e+07</span><span class="w">
  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1.87891e+07</span><span class="w">
  </span><span class="n">pbar_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5.24774e+06</span><span class="w">
  </span><span class="n">yieldParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">BETA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">CR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">FSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.355309</span><span class="p">,</span><span class="w"> </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">996.118</span><span class="p">,</span><span class="w"> </span><span class="n">STREN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.76382e+07</span><span class="p">,</span><span class="w"> </span><span class="n">YSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.353622</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">52172.3</span><span class="p">,</span><span class="m">3.60195e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.15079e+06</span><span class="p">,</span><span class="m">2.02165e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-878986</span><span class="p">,</span><span class="m">-970925</span><span class="p">,</span><span class="m">-1.06186e+06</span><span class="p">,</span><span class="m">-1.15079e+06</span><span class="p">,</span><span class="m">-1.23674e+06</span><span class="p">,</span><span class="m">-1.31877e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1.62388e+06</span><span class="p">,</span><span class="m">1.7838e+06</span><span class="p">,</span><span class="m">1.91864e+06</span><span class="p">,</span><span class="m">2.02165e+06</span><span class="p">,</span><span class="m">2.08688e+06</span><span class="p">,</span><span class="m">2.10948e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">zr_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zr_df</span><span class="p">,</span><span class="w">
  </span><span class="n">ComputeFullYieldSurface</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">pbar_w</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">num_points</span><span class="p">,</span><span class="w">
                          </span><span class="n">z_r_pt</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w">
                          </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">))</span><span class="w">
  </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="w">
  </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3.98447e+07</span><span class="w">
  </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.32816e+07</span><span class="w">
  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1.87891e+07</span><span class="w">
  </span><span class="n">pbar_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5.24774e+06</span><span class="w">
  </span><span class="n">yieldParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">BETA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">CR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">FSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.355309</span><span class="p">,</span><span class="w"> </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">996.118</span><span class="p">,</span><span class="w"> </span><span class="n">STREN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.76382e+07</span><span class="p">,</span><span class="w"> </span><span class="n">YSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.353622</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">52172.3</span><span class="p">,</span><span class="m">3.60195e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18969e+06</span><span class="p">,</span><span class="m">2.05584e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.09888e+06</span><span class="p">,</span><span class="m">-1.14468e+06</span><span class="p">,</span><span class="m">-1.18969e+06</span><span class="p">,</span><span class="m">-1.2338e+06</span><span class="p">,</span><span class="m">-1.27687e+06</span><span class="p">,</span><span class="m">-1.31877e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1.96539e+06</span><span class="p">,</span><span class="m">2.01563e+06</span><span class="p">,</span><span class="m">2.05584e+06</span><span class="p">,</span><span class="m">2.0853e+06</span><span class="p">,</span><span class="m">2.10336e+06</span><span class="p">,</span><span class="m">2.10948e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">zr_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zr_df</span><span class="p">,</span><span class="w">
  </span><span class="n">ComputeFullYieldSurface</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">pbar_w</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">num_points</span><span class="p">,</span><span class="w">
                          </span><span class="n">z_r_pt</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w">
                          </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">))</span><span class="w">
  </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="w">
  </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3.98447e+07</span><span class="w">
  </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.32816e+07</span><span class="w">
  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1.87891e+07</span><span class="w">
  </span><span class="n">pbar_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5.24774e+06</span><span class="w">
  </span><span class="n">yieldParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">BETA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">CR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">FSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.355309</span><span class="p">,</span><span class="w"> </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">996.118</span><span class="p">,</span><span class="w"> </span><span class="n">STREN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.76382e+07</span><span class="p">,</span><span class="w"> </span><span class="n">YSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.353622</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">52172.3</span><span class="p">,</span><span class="m">3.60195e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18723e+06</span><span class="p">,</span><span class="m">2.05389e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.09888e+06</span><span class="p">,</span><span class="m">-1.12123e+06</span><span class="p">,</span><span class="m">-1.14342e+06</span><span class="p">,</span><span class="m">-1.16542e+06</span><span class="p">,</span><span class="m">-1.18723e+06</span><span class="p">,</span><span class="m">-1.20882e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1.96539e+06</span><span class="p">,</span><span class="m">1.99102e+06</span><span class="p">,</span><span class="m">2.01438e+06</span><span class="p">,</span><span class="m">2.03536e+06</span><span class="p">,</span><span class="m">2.05389e+06</span><span class="p">,</span><span class="m">2.06989e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">zr_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zr_df</span><span class="p">,</span><span class="w">
  </span><span class="n">ComputeFullYieldSurface</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">pbar_w</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">num_points</span><span class="p">,</span><span class="w">
                          </span><span class="n">z_r_pt</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w">
                          </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">))</span><span class="w">
  </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="w">
  </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3.98447e+07</span><span class="w">
  </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.32816e+07</span><span class="w">
  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1.87891e+07</span><span class="w">
  </span><span class="n">pbar_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5.24774e+06</span><span class="w">
  </span><span class="n">yieldParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">BETA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">CR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">FSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.355309</span><span class="p">,</span><span class="w"> </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">996.118</span><span class="p">,</span><span class="w"> </span><span class="n">STREN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.76382e+07</span><span class="p">,</span><span class="w"> </span><span class="n">YSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.353622</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">52172.3</span><span class="p">,</span><span class="m">3.60195e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18699e+06</span><span class="p">,</span><span class="m">2.05371e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.15385e+06</span><span class="p">,</span><span class="m">-1.16495e+06</span><span class="p">,</span><span class="m">-1.176e+06</span><span class="p">,</span><span class="m">-1.18699e+06</span><span class="p">,</span><span class="m">-1.19794e+06</span><span class="p">,</span><span class="m">-1.20882e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2.0246e+06</span><span class="p">,</span><span class="m">2.03493e+06</span><span class="p">,</span><span class="m">2.04464e+06</span><span class="p">,</span><span class="m">2.05371e+06</span><span class="p">,</span><span class="m">2.06213e+06</span><span class="p">,</span><span class="m">2.06989e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">zr_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zr_df</span><span class="p">,</span><span class="w">
  </span><span class="n">ComputeFullYieldSurface</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">pbar_w</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">num_points</span><span class="p">,</span><span class="w">
                          </span><span class="n">z_r_pt</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w">
                          </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">))</span><span class="w">
  </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span><span class="w">
  </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3.98447e+07</span><span class="w">
  </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.32816e+07</span><span class="w">
  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1.87891e+07</span><span class="w">
  </span><span class="n">pbar_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5.24774e+06</span><span class="w">
  </span><span class="n">yieldParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">BETA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">CR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">FSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.355309</span><span class="p">,</span><span class="w"> </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">996.118</span><span class="p">,</span><span class="w"> </span><span class="n">STREN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.76382e+07</span><span class="p">,</span><span class="w"> </span><span class="n">YSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.353622</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">52172.3</span><span class="p">,</span><span class="m">3.60195e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18686e+06</span><span class="p">,</span><span class="m">2.0536e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18133e+06</span><span class="p">,</span><span class="m">-1.18686e+06</span><span class="p">,</span><span class="m">-1.19237e+06</span><span class="p">,</span><span class="m">-1.19787e+06</span><span class="p">,</span><span class="m">-1.20335e+06</span><span class="p">,</span><span class="m">-1.20882e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2.04911e+06</span><span class="p">,</span><span class="m">2.0536e+06</span><span class="p">,</span><span class="m">2.05792e+06</span><span class="p">,</span><span class="m">2.06208e+06</span><span class="p">,</span><span class="m">2.06607e+06</span><span class="p">,</span><span class="m">2.06989e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">zr_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zr_df</span><span class="p">,</span><span class="w">
  </span><span class="n">ComputeFullYieldSurface</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">pbar_w</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">num_points</span><span class="p">,</span><span class="w">
                          </span><span class="n">z_r_pt</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w">
                          </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">))</span><span class="w">
  </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span><span class="w">
  </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3.98447e+07</span><span class="w">
  </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.32816e+07</span><span class="w">
  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1.87891e+07</span><span class="w">
  </span><span class="n">pbar_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5.24774e+06</span><span class="w">
  </span><span class="n">yieldParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">BETA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">CR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">FSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.355309</span><span class="p">,</span><span class="w"> </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">996.118</span><span class="p">,</span><span class="w"> </span><span class="n">STREN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.76382e+07</span><span class="p">,</span><span class="w"> </span><span class="n">YSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.353622</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">52172.3</span><span class="p">,</span><span class="m">3.60195e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18684e+06</span><span class="p">,</span><span class="m">2.05359e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18133e+06</span><span class="p">,</span><span class="m">-1.18409e+06</span><span class="p">,</span><span class="m">-1.18684e+06</span><span class="p">,</span><span class="m">-1.18959e+06</span><span class="p">,</span><span class="m">-1.19234e+06</span><span class="p">,</span><span class="m">-1.19508e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2.04911e+06</span><span class="p">,</span><span class="m">2.05137e+06</span><span class="p">,</span><span class="m">2.05359e+06</span><span class="p">,</span><span class="m">2.05576e+06</span><span class="p">,</span><span class="m">2.05789e+06</span><span class="p">,</span><span class="m">2.05999e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">zr_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zr_df</span><span class="p">,</span><span class="w">
  </span><span class="n">ComputeFullYieldSurface</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">pbar_w</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">num_points</span><span class="p">,</span><span class="w">
                          </span><span class="n">z_r_pt</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w">
                          </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">))</span><span class="w">
  </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">9</span><span class="w">
  </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3.98447e+07</span><span class="w">
  </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.32816e+07</span><span class="w">
  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1.87891e+07</span><span class="w">
  </span><span class="n">pbar_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5.24774e+06</span><span class="w">
  </span><span class="n">yieldParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">BETA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">CR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">FSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.355309</span><span class="p">,</span><span class="w"> </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">996.118</span><span class="p">,</span><span class="w"> </span><span class="n">STREN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.76382e+07</span><span class="p">,</span><span class="w"> </span><span class="n">YSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.353622</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">52172.3</span><span class="p">,</span><span class="m">3.60195e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18683e+06</span><span class="p">,</span><span class="m">2.05358e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18133e+06</span><span class="p">,</span><span class="m">-1.18271e+06</span><span class="p">,</span><span class="m">-1.18409e+06</span><span class="p">,</span><span class="m">-1.18546e+06</span><span class="p">,</span><span class="m">-1.18683e+06</span><span class="p">,</span><span class="m">-1.18821e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2.04911e+06</span><span class="p">,</span><span class="m">2.05025e+06</span><span class="p">,</span><span class="m">2.05137e+06</span><span class="p">,</span><span class="m">2.05248e+06</span><span class="p">,</span><span class="m">2.05358e+06</span><span class="p">,</span><span class="m">2.05467e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">zr_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zr_df</span><span class="p">,</span><span class="w">
  </span><span class="n">ComputeFullYieldSurface</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">pbar_w</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">num_points</span><span class="p">,</span><span class="w">
                          </span><span class="n">z_r_pt</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w">
                          </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">))</span><span class="w">
  </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="w">
  </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3.98447e+07</span><span class="w">
  </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.32816e+07</span><span class="w">
  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1.87891e+07</span><span class="w">
  </span><span class="n">pbar_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5.24774e+06</span><span class="w">
  </span><span class="n">yieldParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">BETA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">CR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">FSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.355309</span><span class="p">,</span><span class="w"> </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">996.118</span><span class="p">,</span><span class="w"> </span><span class="n">STREN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.76382e+07</span><span class="p">,</span><span class="w"> </span><span class="n">YSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.353622</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">52172.3</span><span class="p">,</span><span class="m">3.60195e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18658e+06</span><span class="p">,</span><span class="m">2.05338e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18477e+06</span><span class="p">,</span><span class="m">-1.18546e+06</span><span class="p">,</span><span class="m">-1.18615e+06</span><span class="p">,</span><span class="m">-1.18683e+06</span><span class="p">,</span><span class="m">-1.18752e+06</span><span class="p">,</span><span class="m">-1.18821e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2.05192e+06</span><span class="p">,</span><span class="m">2.05248e+06</span><span class="p">,</span><span class="m">2.05303e+06</span><span class="p">,</span><span class="m">2.05358e+06</span><span class="p">,</span><span class="m">2.05412e+06</span><span class="p">,</span><span class="m">2.05467e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">zr_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zr_df</span><span class="p">,</span><span class="w">
  </span><span class="n">ComputeFullYieldSurface</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">pbar_w</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">num_points</span><span class="p">,</span><span class="w">
                          </span><span class="n">z_r_pt</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w">
                          </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">))</span><span class="w">
  </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">11</span><span class="w">
  </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3.98447e+07</span><span class="w">
  </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.32816e+07</span><span class="w">
  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1.87891e+07</span><span class="w">
  </span><span class="n">pbar_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5.24774e+06</span><span class="w">
  </span><span class="n">yieldParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">BETA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">CR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">FSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.355309</span><span class="p">,</span><span class="w"> </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">996.118</span><span class="p">,</span><span class="w"> </span><span class="n">STREN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.76382e+07</span><span class="p">,</span><span class="w"> </span><span class="n">YSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.353622</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">52172.3</span><span class="p">,</span><span class="m">3.60195e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18649e+06</span><span class="p">,</span><span class="m">2.0533e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18649e+06</span><span class="p">,</span><span class="m">-1.18683e+06</span><span class="p">,</span><span class="m">-1.18718e+06</span><span class="p">,</span><span class="m">-1.18752e+06</span><span class="p">,</span><span class="m">-1.18786e+06</span><span class="p">,</span><span class="m">-1.18821e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2.0533e+06</span><span class="p">,</span><span class="m">2.05358e+06</span><span class="p">,</span><span class="m">2.05385e+06</span><span class="p">,</span><span class="m">2.05412e+06</span><span class="p">,</span><span class="m">2.0544e+06</span><span class="p">,</span><span class="m">2.05467e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">zr_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zr_df</span><span class="p">,</span><span class="w">
  </span><span class="n">ComputeFullYieldSurface</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">pbar_w</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">num_points</span><span class="p">,</span><span class="w">
                          </span><span class="n">z_r_pt</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w">
                          </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">))</span><span class="w">
  </span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="w">
  </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3.98447e+07</span><span class="w">
  </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.32816e+07</span><span class="w">
  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1.87891e+07</span><span class="w">
  </span><span class="n">pbar_w</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5.24774e+06</span><span class="w">
  </span><span class="n">yieldParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">BETA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">CR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">FSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.355309</span><span class="p">,</span><span class="w"> </span><span class="n">PEAKI1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">996.118</span><span class="p">,</span><span class="w"> </span><span class="n">STREN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.76382e+07</span><span class="p">,</span><span class="w"> </span><span class="n">YSLOPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.353622</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_pt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">52172.3</span><span class="p">,</span><span class="m">3.60195e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18649e+06</span><span class="p">,</span><span class="m">2.0533e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-1.18649e+06</span><span class="p">,</span><span class="m">-1.18666e+06</span><span class="p">,</span><span class="m">-1.18683e+06</span><span class="p">,</span><span class="m">-1.187e+06</span><span class="p">,</span><span class="m">-1.18718e+06</span><span class="p">,</span><span class="m">-1.18735e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">z_r_yield_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2.0533e+06</span><span class="p">,</span><span class="m">2.05344e+06</span><span class="p">,</span><span class="m">2.05358e+06</span><span class="p">,</span><span class="m">2.05371e+06</span><span class="p">,</span><span class="m">2.05385e+06</span><span class="p">,</span><span class="m">2.05399e+06</span><span class="p">)</span><span class="w">
  </span><span class="n">zr_df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">zr_df</span><span class="p">,</span><span class="w">
  </span><span class="n">ComputeFullYieldSurface</span><span class="p">(</span><span class="n">yieldParams</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">pbar_w</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">num_points</span><span class="p">,</span><span class="w">
                          </span><span class="n">z_r_pt</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_closest</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_z</span><span class="p">,</span><span class="w"> </span><span class="n">z_r_yield_r</span><span class="p">,</span><span class="w">
                          </span><span class="n">iteration</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">))</span><span class="w">
  </span><span class="n">createGIFIterations</span><span class="p">(</span><span class="n">zr_df</span><span class="p">,</span><span class="w"> </span><span class="n">consistency_iter</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">#-------------------------------------------------------------------------</span><span class="w">
</span><span class="c1"># Call function to read data and plot</span><span class="w">
</span><span class="c1">#-------------------------------------------------------------------------</span><span class="w">
</span><span class="n">ReadAndPlotClosestPoint</span><span class="p">()</span></code></pre></figure>

<p>Let us explore how the animation at the top of the docs was produced using <a href="https://d3js.org/">d3.js</a>.</p>

<h4 id="input-data">Input data</h4>
<p>The input data that can be seen in the <code class="language-plaintext highlighter-rouge">R</code> function <code class="language-plaintext highlighter-rouge">ReadAndPlotClosestPoint</code> were generated
during a simulation using print statements.  These have to be converted into a form that can
be read easily by Javascript.  For our simulation we converted these into JSON and created the
file <code class="language-plaintext highlighter-rouge">yieldSurfData.json</code> that contains:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"num_points"</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="w">
  </span><span class="nl">"consistency_iter"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"iteration"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"K"</span><span class="p">:</span><span class="mf">3.98447e+07</span><span class="p">,</span><span class="w">
      </span><span class="nl">"G"</span><span class="p">:</span><span class="mf">1.32816e+07</span><span class="p">,</span><span class="w">
      </span><span class="nl">"X"</span><span class="p">:</span><span class="mf">-1.87891e+07</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pbar_w"</span><span class="p">:</span><span class="mf">5.24774e+06</span><span class="p">,</span><span class="w">
      </span><span class="nl">"BETA"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="nl">"CR"</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span><span class="w">
      </span><span class="nl">"FSLOPE"</span><span class="p">:</span><span class="mf">0.355309</span><span class="p">,</span><span class="w">
      </span><span class="nl">"PEAKI1"</span><span class="p">:</span><span class="mf">996.118</span><span class="p">,</span><span class="w">
      </span><span class="nl">"STREN"</span><span class="p">:</span><span class="mf">1.76382e+07</span><span class="p">,</span><span class="w">
      </span><span class="nl">"YSLOPE"</span><span class="p">:</span><span class="mf">0.353622</span><span class="p">,</span><span class="w">
      </span><span class="nl">"z_r_pt"</span><span class="p">:[</span><span class="w">
        </span><span class="mf">52172.3</span><span class="p">,</span><span class="w">
        </span><span class="mf">3.60195e+06</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"z_r_closest"</span><span class="p">:[</span><span class="w">
        </span><span class="mf">-1.15079e+06</span><span class="p">,</span><span class="w">
        </span><span class="mf">2.02165e+06</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"z_r_yield_z"</span><span class="p">:[</span><span class="w">
        </span><span class="mf">575.109</span><span class="p">,</span><span class="w">
        </span><span class="mi">-167406</span><span class="p">,</span><span class="w">
        </span><span class="mi">-607187</span><span class="p">,</span><span class="w">
        </span><span class="mf">-1.15079e+06</span><span class="p">,</span><span class="w">
        </span><span class="mf">-1.59057e+06</span><span class="p">,</span><span class="w">
        </span><span class="mf">-1.75855e+06</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"z_r_yield_r"</span><span class="p">:[</span><span class="w">
        </span><span class="mf">2.45257e-09</span><span class="p">,</span><span class="w">
        </span><span class="mi">310133</span><span class="p">,</span><span class="w">
        </span><span class="mf">1.12207e+06</span><span class="p">,</span><span class="w">
        </span><span class="mf">2.02165e+06</span><span class="p">,</span><span class="w">
        </span><span class="mf">1.72669e+06</span><span class="p">,</span><span class="w">
        </span><span class="mi">0</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">.....</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure>

<h4 id="the-html-file">The HTML file</h4>
<p>In the HTML file, I added the following to allow the animation to be added to the DOM.</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html">  <span class="nt">&lt;body&gt;</span>
     ...
     <span class="c">&lt;!-- Create div where the svg canvas will be added --&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"yield-surf-canvas"</span><span class="nt">&gt;</span> <span class="nt">&lt;/div&gt;</span>
     <span class="c">&lt;!-- Load D3.js --&gt;</span>
     <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://d3js.org/d3.v4.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
     <span class="c">&lt;!-- Load javascript for animating yield surface --&gt;</span>
     <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/ParSim/assets/js/yieldsurface.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
     <span class="nt">&lt;script&gt;</span>
       <span class="c1">// Read JSON file and then call javascript function to animate yield surface </span>
       <span class="nx">d3</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="dl">"</span><span class="s2">/ParSim/assets/json/yieldSurfData.json</span><span class="dl">"</span><span class="p">,</span> <span class="nx">drawYieldSurface</span><span class="p">);</span>
     <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span></code></pre></figure>

<h4 id="the-javascript-code">The Javascript code</h4>
<p>Let us now explore the Javascript code used to generate the animation.</p>

<h5 id="generating-points-on-the-yield-surface">Generating points on the yield surface</h5>
<p>We first generate points on the yield surface in \(z-r'\)-space.  These are displayed in blue in the figure.
The function <code class="language-plaintext highlighter-rouge">computeYieldSurface</code> takes an input the data for a single iteration (read from the
JSON file) and the number of points to be used to discretize the yield surface.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">computeYieldSurface</span><span class="p">(</span><span class="nx">iterData</span><span class="p">,</span> <span class="nx">numPts</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Get the moduli</span>
  <span class="kd">let</span> <span class="nx">K</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">[</span><span class="dl">'</span><span class="s1">K</span><span class="dl">'</span><span class="p">];</span>
  <span class="kd">let</span> <span class="nx">G</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">[</span><span class="dl">'</span><span class="s1">G</span><span class="dl">'</span><span class="p">];</span>

  <span class="c1">// Get yield parameters</span>
  <span class="kd">let</span> <span class="nx">PEAKI1</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">[</span><span class="dl">'</span><span class="s1">PEAKI1</span><span class="dl">'</span><span class="p">];</span>
  <span class="kd">let</span> <span class="nx">FSLOPE</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">[</span><span class="dl">'</span><span class="s1">FSLOPE</span><span class="dl">'</span><span class="p">];</span>
  <span class="kd">let</span> <span class="nx">STREN</span>  <span class="o">=</span> <span class="nx">iterData</span><span class="p">[</span><span class="dl">'</span><span class="s1">STREN</span><span class="dl">'</span><span class="p">];</span>
  <span class="kd">let</span> <span class="nx">YSLOPE</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">[</span><span class="dl">'</span><span class="s1">YSLOPE</span><span class="dl">'</span><span class="p">];</span>
  <span class="kd">let</span> <span class="nx">CR</span>     <span class="o">=</span> <span class="nx">iterData</span><span class="p">[</span><span class="dl">'</span><span class="s1">CR</span><span class="dl">'</span><span class="p">];</span>

  <span class="c1">// Set up constants</span>
  <span class="kd">let</span> <span class="nx">a1</span> <span class="o">=</span> <span class="nx">STREN</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">a2</span> <span class="o">=</span> <span class="p">(</span><span class="nx">FSLOPE</span><span class="o">-</span><span class="nx">YSLOPE</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nx">STREN</span><span class="o">-</span><span class="nx">YSLOPE</span><span class="o">*</span><span class="nx">PEAKI1</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">a3</span> <span class="o">=</span> <span class="p">(</span><span class="nx">STREN</span><span class="o">-</span><span class="nx">YSLOPE</span><span class="o">*</span><span class="nx">PEAKI1</span><span class="p">)</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="o">-</span><span class="nx">a2</span><span class="o">*</span><span class="nx">PEAKI1</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">a4</span> <span class="o">=</span> <span class="nx">YSLOPE</span><span class="p">;</span>

  <span class="c1">// Compute kappa</span>
  <span class="kd">let</span> <span class="nx">X_eff</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">[</span><span class="dl">'</span><span class="s1">X</span><span class="dl">'</span><span class="p">]</span> <span class="o">+</span> <span class="mf">3.0</span><span class="o">*</span><span class="nx">iterData</span><span class="p">[</span><span class="dl">'</span><span class="s1">pbar_w</span><span class="dl">'</span><span class="p">];</span>
  <span class="kd">let</span> <span class="nx">kappa</span> <span class="o">=</span> <span class="nx">PEAKI1</span> <span class="o">-</span> <span class="nx">CR</span><span class="o">*</span><span class="p">(</span><span class="nx">PEAKI1</span> <span class="o">-</span> <span class="nx">X_eff</span><span class="p">);</span>

  <span class="c1">// Create an array of I1_eff values</span>
  <span class="kd">let</span> <span class="nx">I1eff_min</span> <span class="o">=</span> <span class="nx">X_eff</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">I1eff_max</span> <span class="o">=</span> <span class="nx">PEAKI1</span><span class="p">;</span>

  <span class="kd">let</span> <span class="nx">rad</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="nx">PEAKI1</span> <span class="o">-</span> <span class="nx">X_eff</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">cen</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="nx">PEAKI1</span> <span class="o">+</span> <span class="nx">X_eff</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">theta_max</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">acos</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">((</span><span class="nx">I1eff_min</span> <span class="o">-</span> <span class="nx">cen</span><span class="p">)</span><span class="o">/</span><span class="nx">rad</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">));</span>
  <span class="kd">let</span> <span class="nx">theta_min</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">acos</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">((</span><span class="nx">I1eff_max</span> <span class="o">-</span> <span class="nx">cen</span><span class="p">)</span><span class="o">/</span><span class="nx">rad</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">));</span>
  <span class="kd">let</span> <span class="nx">theta_inc</span> <span class="o">=</span> <span class="p">(</span><span class="nx">theta_max</span><span class="o">-</span><span class="nx">theta_min</span><span class="p">)</span><span class="o">/</span><span class="nx">numPts</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">theta_vec</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">theta_min</span><span class="p">,</span> <span class="nx">theta_max</span><span class="o">+</span><span class="nx">theta_inc</span><span class="p">,</span> <span class="nx">theta_inc</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">I1_list</span> <span class="o">=</span> <span class="nx">theta_vec</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">theta</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">cen</span> <span class="o">+</span> <span class="nx">rad</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">theta</span><span class="p">);});</span>
  <span class="kd">let</span> <span class="nx">I1_eff_list</span> <span class="o">=</span> <span class="nx">I1_list</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">I1</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">I1</span><span class="p">,</span> <span class="nx">X_eff</span><span class="p">);});</span>

  <span class="c1">// Create an array of sqrtJ2 values</span>
  <span class="kd">let</span> <span class="nx">sqrtJ2_list</span> <span class="o">=</span> <span class="nx">I1_eff_list</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span>
          <span class="kd">function</span><span class="p">(</span><span class="nx">I1_eff</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Compute F_f</span>
            <span class="kd">let</span> <span class="nx">Ff</span> <span class="o">=</span> <span class="nx">a1</span> <span class="o">-</span> <span class="nx">a3</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="nx">a2</span><span class="o">*</span><span class="nx">I1_eff</span><span class="p">)</span> <span class="o">-</span> <span class="nx">a4</span><span class="o">*</span><span class="p">(</span><span class="nx">I1_eff</span><span class="p">);</span>

            <span class="c1">// Compute Fc</span>
            <span class="kd">let</span> <span class="nx">Fc_sq</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">((</span><span class="nx">I1_eff</span> <span class="o">&lt;</span> <span class="nx">kappa</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">X_eff</span> <span class="o">&lt;=</span> <span class="nx">I1_eff</span><span class="p">))</span> <span class="p">{</span>
              <span class="kd">let</span> <span class="nx">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="nx">kappa</span> <span class="o">-</span> <span class="nx">I1_eff</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nx">kappa</span> <span class="o">-</span> <span class="nx">X_eff</span><span class="p">);</span>
              <span class="nx">Fc_sq</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nx">ratio</span><span class="o">*</span><span class="nx">ratio</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// Compute sqrt(J2)</span>
            <span class="kd">let</span> <span class="nx">sqrtJ2</span> <span class="o">=</span> <span class="nx">Ff</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">Fc_sq</span><span class="p">);</span>
            <span class="k">return</span><span class="p">(</span><span class="nx">sqrtJ2</span><span class="p">);</span>
          <span class="p">});</span>

  <span class="c1">// Compute z and r'</span>
  <span class="kd">let</span> <span class="nx">z_list</span> <span class="o">=</span> <span class="nx">I1_eff_list</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">I1_eff</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">I1_eff</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="mf">3.0</span><span class="p">);});</span>
  <span class="kd">let</span> <span class="nx">rprime_list</span> <span class="o">=</span> <span class="nx">sqrtJ2_list</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">sqrtJ2</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">sqrtJ2</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="nx">K</span><span class="o">/</span><span class="nx">G</span><span class="p">);});</span>

  <span class="c1">// Create zipped array</span>
  <span class="kd">let</span> <span class="nx">zrprime_data</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">zip</span><span class="p">(</span><span class="nx">z_list</span><span class="p">,</span> <span class="nx">rprime_list</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">zrprime_data</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>The procedure is identical to that used in the <code class="language-plaintext highlighter-rouge">R</code> script, except for two differences:</p>

<ul>
  <li>the <code class="language-plaintext highlighter-rouge">d3.range</code> function is used to create the vector of \(\theta\) values.  This function
differs from the <code class="language-plaintext highlighter-rouge">R</code> function <code class="language-plaintext highlighter-rouge">seq</code> in that the end point of the range is not included in
the sequence that is produced.  Therefore, the set of points produced by <code class="language-plaintext highlighter-rouge">d3.js</code> is not
identical to that produced by <code class="language-plaintext highlighter-rouge">R</code>.</li>
  <li>the function returns a zipped array created with <code class="language-plaintext highlighter-rouge">d3.zip</code> instead of a <code class="language-plaintext highlighter-rouge">R</code> dataframe.</li>
</ul>

<h5 id="drawing-the-yield-surface-and-closest-point-projection">Drawing the yield surface and closest-point projection</h5>
<p>We use the <code class="language-plaintext highlighter-rouge">drawYieldSurface</code> function to plot and animate the yield surface and the closest-point
projection.  Let us look at the full code first and then explore some of the details.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">drawYieldSurface</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Create svg</span>
  <span class="kd">var</span> <span class="nx">svgsize</span> <span class="o">=</span> <span class="p">{</span><span class="na">x</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">600</span><span class="p">};</span>
  <span class="kd">var</span> <span class="nx">margin</span> <span class="o">=</span> <span class="p">{</span><span class="na">top</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="na">right</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="na">bottom</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="na">left</span><span class="p">:</span> <span class="mi">50</span><span class="p">};</span>
  <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">svgsize</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">right</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">svgsize</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">bottom</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="dl">"</span><span class="s2">.yield-surf-canvas</span><span class="dl">"</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">svg</span><span class="dl">"</span><span class="p">)</span>
                 <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">width</span><span class="dl">"</span><span class="p">,</span> <span class="nx">svgsize</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
                 <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">height</span><span class="dl">"</span><span class="p">,</span> <span class="nx">svgsize</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>

  <span class="c1">// Create chart area</span>
  <span class="kd">var</span> <span class="nx">chart</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">g</span><span class="dl">"</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">chart</span><span class="dl">"</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">transform</span><span class="dl">"</span><span class="p">,</span> 
                          <span class="dl">"</span><span class="s2">translate(</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">,</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">)</span><span class="dl">"</span><span class="p">);</span>

  <span class="c1">// Process the input data</span>
  <span class="kd">let</span> <span class="nx">numPts</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="dl">'</span><span class="s1">num_points</span><span class="dl">'</span><span class="p">];</span>
  <span class="kd">let</span> <span class="nx">numIter</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

  <span class="c1">// Compute yield surface in z and r' from first element of data</span>
  <span class="c1">// (Note: the yield surface does not change at each iteration)</span>
  <span class="kd">let</span> <span class="nx">iterData</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kd">let</span> <span class="nx">zrprime</span> <span class="o">=</span> <span class="nx">computeYieldSurface</span><span class="p">(</span><span class="nx">iterData</span><span class="p">,</span> <span class="nx">numPts</span><span class="p">);</span>

  <span class="c1">// Get the coordinates of the trial stress</span>
  <span class="kd">let</span> <span class="nx">ztrial</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">.</span><span class="nx">z_r_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kd">let</span> <span class="nx">rprimetrial</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">.</span><span class="nx">z_r_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

  <span class="c1">// Compute min max of domain</span>
  <span class="kd">let</span> <span class="nx">zmin</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">zrprime</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">];})</span>
  <span class="kd">let</span> <span class="nx">zmax</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">zrprime</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">];})</span>
  <span class="kd">let</span> <span class="nx">rprimemin</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">zrprime</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">];})</span>
  <span class="kd">let</span> <span class="nx">rprimemax</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">zrprime</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">];})</span>
  <span class="nx">zmin</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">zmin</span><span class="p">,</span> <span class="nx">ztrial</span><span class="p">);</span>
  <span class="nx">zmax</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">zmax</span><span class="p">,</span> <span class="nx">ztrial</span><span class="p">);</span>
  <span class="nx">rprimemin</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">rprimemin</span><span class="p">,</span> <span class="nx">rprimetrial</span><span class="p">);</span>
  <span class="nx">rprimemax</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">rprimemax</span><span class="p">,</span> <span class="nx">rprimetrial</span><span class="p">);</span>

  <span class="c1">// Create scaling functions</span>
  <span class="kd">var</span> <span class="nx">xscale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="nx">zmin</span><span class="p">,</span> <span class="nx">zmax</span><span class="p">]).</span><span class="nx">rangeRound</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">width</span><span class="p">]);</span>
  <span class="kd">var</span> <span class="nx">yscale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="nx">rprimemin</span><span class="p">,</span> <span class="nx">rprimemax</span><span class="p">]).</span><span class="nx">rangeRound</span><span class="p">([</span><span class="nx">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>
  <span class="kd">var</span> <span class="nx">xscaleAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="nx">zmin</span><span class="o">*</span><span class="mf">1.0</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="nx">zmax</span><span class="o">*</span><span class="mf">1.0</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">]).</span><span class="nx">rangeRound</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">width</span><span class="p">]);</span>
  <span class="kd">var</span> <span class="nx">yscaleAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="nx">rprimemin</span><span class="o">*</span><span class="mf">1.0</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="nx">rprimemax</span><span class="o">*</span><span class="mf">1.0</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">]).</span><span class="nx">rangeRound</span><span class="p">([</span><span class="nx">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>

  <span class="c1">// Create polyline generation function</span>
  <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">line</span><span class="p">()</span>
                 <span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">xscale</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="p">})</span>
                 <span class="p">.</span><span class="nx">y</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">yscale</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="p">});</span>

  <span class="c1">// Create bottom axis</span>
  <span class="nx">chart</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">g</span><span class="dl">"</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">transform</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">translate(0,</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">height</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">)</span><span class="dl">"</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">axisBottom</span><span class="p">(</span><span class="nx">xscaleAxis</span><span class="p">))</span>
        <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">fill</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">#000</span><span class="dl">"</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">transform</span><span class="dl">"</span><span class="p">,</span>
                 <span class="dl">"</span><span class="s2">translate(</span><span class="dl">"</span> <span class="o">+</span> <span class="p">(</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> ,</span><span class="dl">"</span> <span class="o">+</span> 
                                <span class="p">(</span><span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">)</span><span class="dl">"</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">text-anchor</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">end</span><span class="dl">"</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="dl">"</span><span class="s2">z (MPa)</span><span class="dl">"</span><span class="p">);</span> 

  <span class="c1">// Create left axis</span>
  <span class="nx">chart</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">g</span><span class="dl">"</span><span class="p">)</span>
       <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">axisLeft</span><span class="p">(</span><span class="nx">yscaleAxis</span><span class="p">))</span>
       <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">fill</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">#000</span><span class="dl">"</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">transform</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">rotate(-90)</span><span class="dl">"</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">y</span><span class="dl">"</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">dy</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">0.71em</span><span class="dl">"</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">text-anchor</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">end</span><span class="dl">"</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="dl">"</span><span class="s2">r' (MPa)</span><span class="dl">"</span><span class="p">);</span> 

  <span class="c1">// Plot yield surface</span>
  <span class="nx">chart</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">yield_surf</span><span class="dl">"</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">datum</span><span class="p">(</span><span class="nx">zrprime</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">fill</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">none</span><span class="dl">"</span><span class="p">)</span>    
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">steelblue</span><span class="dl">"</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke-linejoin</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">round</span><span class="dl">"</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke-linecap</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">round</span><span class="dl">"</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke-width</span><span class="dl">"</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">d</span><span class="dl">"</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>

  <span class="c1">// Loop through the iterations</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">iter</span> <span class="o">&lt;</span> <span class="nx">numIter</span><span class="p">;</span> <span class="nx">iter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">iterData</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">iter</span><span class="p">];</span>

    <span class="c1">// Create group for each iteration</span>
    <span class="kd">let</span> <span class="nx">iterGroup</span> <span class="o">=</span> <span class="nx">chart</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">g</span><span class="dl">"</span><span class="p">)</span>
                            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">iteration</span><span class="dl">"</span><span class="o">+</span><span class="nx">iter</span><span class="p">)</span>
                            <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">opacity</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Create group for the yield surface points + circles</span>
    <span class="kd">let</span> <span class="nx">yieldSurfGroup</span> <span class="o">=</span> <span class="nx">iterGroup</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">g</span><span class="dl">"</span><span class="p">)</span> 
                                     <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">approx_yield_surf</span><span class="dl">"</span><span class="o">+</span><span class="nx">iter</span><span class="p">);</span>

    <span class="c1">// Get the coordinates of polyline approximation</span>
    <span class="kd">let</span> <span class="nx">zpoly</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">.</span><span class="nx">z_r_yield_z</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">rprimepoly</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">.</span><span class="nx">z_r_yield_r</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">zrprimepoly</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">zip</span><span class="p">(</span><span class="nx">zpoly</span><span class="p">,</span> <span class="nx">rprimepoly</span><span class="p">);</span>

    <span class="c1">// Add the yield surface polyline to the svg</span>
    <span class="nx">yieldSurfGroup</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">datum</span><span class="p">(</span><span class="nx">zrprimepoly</span><span class="p">)</span>
                     <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">fill</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">none</span><span class="dl">"</span><span class="p">)</span>    
                     <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">red</span><span class="dl">"</span><span class="p">)</span>
                     <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke-linejoin</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">round</span><span class="dl">"</span><span class="p">)</span>
                     <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke-linecap</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">round</span><span class="dl">"</span><span class="p">)</span>
                     <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke-width</span><span class="dl">"</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
                     <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">d</span><span class="dl">"</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>

    <span class="c1">// Add circles to the yield surface polyline</span>
    <span class="nx">yieldSurfGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="dl">"</span><span class="s2">.approx_yield_surf_circle</span><span class="dl">"</span><span class="o">+</span><span class="nx">iter</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">zrprimepoly</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
                  <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">circle</span><span class="dl">"</span><span class="p">)</span>
                     <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">r</span><span class="dl">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                     <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">cx</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">xscale</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]);})</span>
                     <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">cy</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">yscale</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]);})</span>
                     <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">fill</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">blue</span><span class="dl">"</span><span class="p">)</span>
                     <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">black</span><span class="dl">"</span><span class="p">);</span>

    <span class="c1">// Create group for the projection line and points</span>
    <span class="kd">let</span> <span class="nx">projLineGroup</span> <span class="o">=</span> <span class="nx">iterGroup</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">g</span><span class="dl">"</span><span class="p">)</span> 
                                    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">projection_line</span><span class="dl">"</span><span class="o">+</span><span class="nx">iter</span><span class="p">);</span>

    <span class="c1">// Get the coordinates of the trial stress</span>
    <span class="kd">let</span> <span class="nx">ztrial</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">.</span><span class="nx">z_r_pt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">let</span> <span class="nx">rprimetrial</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">.</span><span class="nx">z_r_pt</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

    <span class="c1">// Get the coordinates of the closest point stress</span>
    <span class="kd">let</span> <span class="nx">zclosest</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">.</span><span class="nx">z_r_closest</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">let</span> <span class="nx">rprimeclosest</span> <span class="o">=</span> <span class="nx">iterData</span><span class="p">.</span><span class="nx">z_r_closest</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

    <span class="c1">// Set up projection line</span>
    <span class="kd">let</span> <span class="nx">zrprimeproj</span> <span class="o">=</span> <span class="p">[[</span><span class="nx">ztrial</span><span class="p">,</span> <span class="nx">rprimetrial</span><span class="p">],[</span><span class="nx">zclosest</span><span class="p">,</span> <span class="nx">rprimeclosest</span><span class="p">]];</span>

    <span class="c1">// Add the projection line to the svg</span>
    <span class="nx">projLineGroup</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">)</span>
                 <span class="p">.</span><span class="nx">datum</span><span class="p">(</span><span class="nx">zrprimeproj</span><span class="p">)</span>
                   <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">fill</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">none</span><span class="dl">"</span><span class="p">)</span>    
                   <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">green</span><span class="dl">"</span><span class="p">)</span>
                   <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke-linejoin</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">round</span><span class="dl">"</span><span class="p">)</span>
                   <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke-linecap</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">round</span><span class="dl">"</span><span class="p">)</span>
                   <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke-width</span><span class="dl">"</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
                   <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">d</span><span class="dl">"</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span>

    <span class="c1">// Add the triangles at the end points of the projection line</span>
    <span class="nx">projLineGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="dl">"</span><span class="s2">.projection_line_point</span><span class="dl">"</span><span class="o">+</span><span class="nx">iter</span><span class="p">)</span>
                 <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">zrprimeproj</span><span class="p">)</span>
                 <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
                 <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">projection_line_point</span><span class="dl">"</span><span class="o">+</span><span class="nx">iter</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">d</span><span class="dl">"</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">symbol</span><span class="p">().</span><span class="nx">type</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">symbolTriangle</span><span class="p">))</span>
                    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">transform</span><span class="dl">"</span><span class="p">,</span> 
                      <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="dl">"</span><span class="s2">translate(</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">xscale</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">,</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">yscale</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">)</span><span class="dl">"</span><span class="p">;});</span>

  <span class="p">}</span> <span class="c1">// End for loop over iterations</span>

  <span class="c1">// Function to do the animation</span>
  <span class="kd">function</span> <span class="nx">drawAnimation</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">iterationID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// Function to draw the surface for the next iteration</span>
    <span class="kd">function</span> <span class="nx">drawNextSurf</span><span class="p">()</span> <span class="p">{</span>

      <span class="nx">d3</span><span class="p">.</span><span class="nx">active</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">opacity</span><span class="dl">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
          <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">opacity</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="nx">iterationID</span><span class="o">++</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">iterationID</span> <span class="o">===</span> <span class="nx">numIter</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">iterationID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">chart</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="dl">"</span><span class="s2">.iteration</span><span class="dl">"</span><span class="o">+</span><span class="nx">iterationID</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
             <span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
             <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
           <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">start</span><span class="dl">"</span><span class="p">,</span> <span class="nx">drawNextSurf</span><span class="p">);</span>            

    <span class="p">}</span> <span class="c1">// end function drawNextSurf</span>

    <span class="c1">// Start the animation</span>
    <span class="nx">chart</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="dl">"</span><span class="s2">.iteration0</span><span class="dl">"</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
           <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
         <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">start</span><span class="dl">"</span><span class="p">,</span> <span class="nx">drawNextSurf</span><span class="p">);</span>

  <span class="p">}</span> <span class="c1">// end function drawAnimation</span>

  <span class="c1">// Do the animation</span>
  <span class="nx">drawAnimation</span><span class="p">();</span>

<span class="p">}</span> </code></pre></figure>

<p>Let us now look at some of the details of the code.</p>

<h6 id="creating-the-svg">Creating the SVG</h6>
<p>First we select the <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> in
our HTML file using <code class="language-plaintext highlighter-rouge">d3.select</code> and add a SVG canvas to it:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="dl">"</span><span class="s2">.yield-surf-canvas</span><span class="dl">"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">svg</span><span class="dl">"</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">width</span><span class="dl">"</span><span class="p">,</span> <span class="nx">svgsize</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">height</span><span class="dl">"</span><span class="p">,</span> <span class="nx">svgsize</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span></code></pre></figure>

<h6 id="creating-the-canvas-group">Creating the canvas group</h6>
<p>Then we create a subset of the SVG canvas as the region where the plot will be
produced and identify it using a group <code class="language-plaintext highlighter-rouge">g</code>.  This area has to be translated
so that the top left hand corner is at the right position.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">chart</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">g</span><span class="dl">"</span><span class="p">)</span>
                 <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">chart</span><span class="dl">"</span><span class="p">)</span>
                 <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">transform</span><span class="dl">"</span><span class="p">,</span> 
                       <span class="dl">"</span><span class="s2">translate(</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">,</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">)</span><span class="dl">"</span><span class="p">);</span></code></pre></figure>

<h6 id="creating-map-from-real-to-canvas-coordinates">Creating map from real to canvas coordinates</h6>
<p>We then compute the true yield surface and find the extents of the domain of
the plot based on the yield surface and the trial stress state.  We use
these extents to create maps from real coordinates to svg coordinates.
Separate maps are also created so that the axis labels can be converted into MPa.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">xscale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">()</span>
                 <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">zmin</span><span class="p">,</span> <span class="nx">zmax</span><span class="p">])</span>
                 <span class="p">.</span><span class="nx">rangeRound</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">width</span><span class="p">]);</span>
<span class="kd">var</span> <span class="nx">yscale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">()</span>
                 <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">rprimemin</span><span class="p">,</span> <span class="nx">rprimemax</span><span class="p">])</span>
                 <span class="p">.</span><span class="nx">rangeRound</span><span class="p">([</span><span class="nx">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>
<span class="kd">var</span> <span class="nx">xscaleAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">()</span>
                     <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">zmin</span><span class="o">*</span><span class="mf">1.0</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="nx">zmax</span><span class="o">*</span><span class="mf">1.0</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">])</span>
                     <span class="p">.</span><span class="nx">rangeRound</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">width</span><span class="p">]);</span>
<span class="kd">var</span> <span class="nx">yscaleAxis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleLinear</span><span class="p">()</span>
                     <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">rprimemin</span><span class="o">*</span><span class="mf">1.0</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="nx">rprimemax</span><span class="o">*</span><span class="mf">1.0</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">])</span>
                     <span class="p">.</span><span class="nx">rangeRound</span><span class="p">([</span><span class="nx">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span></code></pre></figure>

<h6 id="creating-svg-polyline-generator">Creating SVG polyline generator</h6>
<p>To plot the polylines that represent the yield surface, its approximation, and
the closest point projection, we need a function that can convert a set of points
to the SVG representation of a polyline.  We generate that function using
<code class="language-plaintext highlighter-rouge">d3.line</code>:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">line</span><span class="p">()</span>
               <span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">xscale</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="p">})</span>
               <span class="p">.</span><span class="nx">y</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">yscale</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="p">});</span></code></pre></figure>

<h6 id="creating-the-axes-and-the-yield-surface">Creating the axes and the yield surface</h6>
<p>Next, we create the axes.  The generation of axes using <code class="language-plaintext highlighter-rouge">d3.js</code> is straightforward,
but we have to keep in mind that a translation may be required depending on the
position of the axis.</p>

<p>After the axes have been created, we add the polyline representing the yield surface
to the SVG.  This is done using the zipped data returned from the <code class="language-plaintext highlighter-rouge">computeYieldSurface</code>
function.  Because the yield surface does not change during closest-point search iterations,
we use the data from the first iteration to plot this curve.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">chart</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">)</span>
       <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">yield_surf</span><span class="dl">"</span><span class="p">)</span>
     <span class="p">.</span><span class="nx">datum</span><span class="p">(</span><span class="nx">zrprime</span><span class="p">)</span>
       <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">fill</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">none</span><span class="dl">"</span><span class="p">)</span>    
       <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">steelblue</span><span class="dl">"</span><span class="p">)</span>
       <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke-width</span><span class="dl">"</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
       <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">d</span><span class="dl">"</span><span class="p">,</span> <span class="nx">line</span><span class="p">);</span></code></pre></figure>

<p>Notice that we use the <code class="language-plaintext highlighter-rouge">.datum</code> method in this case and that the attribute <code class="language-plaintext highlighter-rouge">d</code> is set
using the <code class="language-plaintext highlighter-rouge">line</code> function we had defined earlier.</p>

<h6 id="creating-groups-for-each-iteration">Creating groups for each iteration</h6>
<p>Now that the fixed content of the plot has been created, we are ready to create the
content that changes between iterations.  To do that, we loop through the iterations
and add a group for each iteration:</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">let</span> <span class="nx">iterGroup</span> <span class="o">=</span> <span class="nx">chart</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">g</span><span class="dl">"</span><span class="p">)</span>
                       <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">iteration</span><span class="dl">"</span><span class="o">+</span><span class="nx">iter</span><span class="p">)</span>
                       <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">opacity</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p>We set the opacity of the group to 0 so that although all the objects in the
plot have been created, none are visible when the animation starts.</p>

<h6 id="adding-circles-to-the-approximate-surface">Adding circles to the approximate surface</h6>
<p>Now we are ready to add in the polyline approximation to the yield surface
in red.  The procedure is identical to the plot of the full yield surface.
We also add circles to each vertex of the polyline using</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">yieldSurfGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="dl">"</span><span class="s2">.approx_yield_surf_circle</span><span class="dl">"</span><span class="o">+</span><span class="nx">iter</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">zrprimepoly</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
                <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">circle</span><span class="dl">"</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">approx_yield_surf_circle</span><span class="dl">"</span><span class="o">+</span><span class="nx">iter</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">r</span><span class="dl">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">cx</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">xscale</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]);})</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">cy</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">yscale</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]);})</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">fill</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">blue</span><span class="dl">"</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">stroke</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">black</span><span class="dl">"</span><span class="p">);</span></code></pre></figure>

<h6 id="adding-triangles-to-the-projection-line">Adding triangles to the projection line</h6>
<p>Next we add the line that represents the closest-point projection (in green)
and add triangles to the end points for clarity.  The triangles are
added using</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">projLineGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="dl">"</span><span class="s2">.projection_line_point</span><span class="dl">"</span><span class="o">+</span><span class="nx">iter</span><span class="p">)</span>
               <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">zrprimeproj</span><span class="p">)</span>
               <span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
               <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">path</span><span class="dl">"</span><span class="p">)</span>
                 <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">class</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">projection_line_point</span><span class="dl">"</span><span class="o">+</span><span class="nx">iter</span><span class="p">)</span>
                 <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">d</span><span class="dl">"</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">symbol</span><span class="p">().</span><span class="nx">type</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">symbolTriangle</span><span class="p">))</span>
                 <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">transform</span><span class="dl">"</span><span class="p">,</span> 
                      <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="dl">"</span><span class="s2">translate(</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">xscale</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">,</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">yscale</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">)</span><span class="dl">"</span><span class="p">;});</span></code></pre></figure>

<h6 id="setting-up-the-animation">Setting up the animation</h6>
<p>Now we can terminate the loop of the iterations and proceed to setting up the animation.
We start the animation by selecting the group that has class <code class="language-plaintext highlighter-rouge">iteration0</code> and use a transition
that takes 1 second to move from one frame to the next.  We call the <code class="language-plaintext highlighter-rouge">drawNextSurf</code> method when
the animation starts.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">chart</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="dl">"</span><span class="s2">.iteration0</span><span class="dl">"</span><span class="p">)</span>
     <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
       <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
     <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">start</span><span class="dl">"</span><span class="p">,</span> <span class="nx">drawNextSurf</span><span class="p">);</span></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">drawNextSurf</code> method changes the opacity of the active group to 1, waits for 1 second,
and then changes back the opacity to 0.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">d3</span><span class="p">.</span><span class="nx">active</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">opacity</span><span class="dl">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="dl">"</span><span class="s2">opacity</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></code></pre></figure>

<p>After that, it increments to iteration count, selects the next group, and recurses after a short delay.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">chart</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="dl">"</span><span class="s2">.iteration</span><span class="dl">"</span><span class="o">+</span><span class="nx">iterationID</span><span class="p">)</span>
     <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
       <span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
       <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
     <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">start</span><span class="dl">"</span><span class="p">,</span> <span class="nx">drawNextSurf</span><span class="p">);</span></code></pre></figure>

<p>To allow for the animation to loop, we set the iteration index to 0 when the total number of
iterations in the data is reached.</p>

<h4 id="remarks">Remarks</h4>
<p>This <code class="language-plaintext highlighter-rouge">d3.js</code> animation took me 2 days to complete, starting from absolutely no knowledge of the
library, and with significant breaks in the workflow.  I’d suggest that, since a novice can learn and
use the library so quickly, <code class="language-plaintext highlighter-rouge">d3.js</code> should be an essential tool in the computational engineers toolbox
to make data available in the form of interactive plots instead of the static (and hard to grasp) plots
that are the norm in engineering literature.</p>

<p>In the next article, we will go back to the work on XML particle data that we had started earlier
and discuss ways to reading XML files using C++ code.</p>

<script src="https://d3js.org/d3.v4.min.js"></script>

<script src="/ParSim/assets/js/yieldsurface.js"></script>

<script>
  d3.json("/ParSim/assets/json/yieldSurfData.json", drawYieldSurface);
</script>


        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/ParSim/categories/#d3js" class="page__taxonomy-item" rel="tag">D3JS</a><span class="sep">, </span>
    
      
      
      <a href="/ParSim/categories/#javascript" class="page__taxonomy-item" rel="tag">Javascript</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-04-01T23:30:00+13:00">April 1, 2017</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Creating+an+animation+with+d3.js%20https%3A%2F%2Fbbanerjee.github.io%2FParSim%2Fjavascript%2Fd3js%2Fd3-animation-closest-point-return%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fbbanerjee.github.io%2FParSim%2Fjavascript%2Fd3js%2Fd3-animation-closest-point-return%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fbbanerjee.github.io%2FParSim%2Fjavascript%2Fd3js%2Fd3-animation-closest-point-return%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ParSim/mechanics/plasticity/algorithm/geometric-closest-point-return/" class="pagination--pager" title="Geometric closest point return algorithm
">Previous</a>
    
    
      <a href="/ParSim/c++/xml/gzip/reading-xml-with-gzipped-data/" class="pagination--pager" title="Reading XML files containing gzipped data in C++
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/fem/meshing/gmsh/gmsh-meshing-for-code-aster/" rel="permalink">Meshes with different element topologies in gmsh (for Code-Aster)
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          39 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">We have been translating a few Code-Aster verification test manuals into English.
The process is not just a straightforward translation of the text in the Fr...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/fem/meshing/gmsh/quadrlateral-meshing-with-gmsh/" rel="permalink">Creating quadrilateral surface meshes with gmsh
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          21 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">The Code-Aster cooling tower modal analysis validation test
FORMA11c comes with a quadrilateral mesh provided by Code-Aster.
Tips on quadrilateral meshing wi...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/fem/cracks/python/salome-meca/code-aster/inspecting-and-manipulating-meshes/" rel="permalink">Inspecting and manipulating meshes in Salome-Meca for Code-Aster
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          30 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">In this article, I will discuss how elements can be selected from deep inside a 3D mesh
in the Salome-Meca environment and manipulated with Python scripts.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/vaango/compiling-vaango-on-a-cray/" rel="permalink">Compiling and running the MPM code Vaango on a Cray
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          16 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction

One of the reasons I switched to cmake for my builds was the need to compile my
Vaango code on a BlueGene/Q system.  The code was previously co...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
    

    <li><a href="/ParSim/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Biswajit Banerjee. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/ParSim/assets/js/main.min.js"></script>










  </body>
</html>
