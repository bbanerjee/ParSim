<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.21.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Parallel domain decomposition for particle methods: Part 3 - Parresia Simulations</title>
<meta name="description" content="The Plimpton method of communicating ghost regions">


  <meta name="author" content="Biswajit Banerjee">
  
  <meta property="article:author" content="Biswajit Banerjee">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Parresia Simulations">
<meta property="og:title" content="Parallel domain decomposition for particle methods: Part 3">
<meta property="og:url" content="https://bbanerjee.github.io/ParSim/mpi/c++/parallel-domain-decomposition-part-3/">


  <meta property="og:description" content="The Plimpton method of communicating ghost regions">







  <meta property="article:published_time" content="2017-07-23T22:30:00+12:00">





  

  


<link rel="canonical" href="https://bbanerjee.github.io/ParSim/mpi/c++/parallel-domain-decomposition-part-3/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Biswajit Banerjee",
      "url": "https://bbanerjee.github.io/ParSim/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/ParSim/feed.xml" type="application/atom+xml" rel="alternate" title="Parresia Simulations Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/ParSim/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<link rel="stylesheet" href="https://bbanerjee.github.io/ParSim/assets/css/parresia.css">

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_HTMLorMML">
  </script>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/ParSim/"><img src="/ParSim/assets/img/ParresiaLogoSep2017_plain.png" alt=""></a>
        
        <a class="site-title" href="/ParSim/">
          Parresia Simulations
          <span class="site-subtitle">Parallel particle and finite element simulation</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/ParSim/docs/articles/">Blog articles</a>
            </li><li class="masthead__menu-item">
              <a href="/ParSim/docs/parsim/">ParSim software</a>
            </li><li class="masthead__menu-item">
              <a href="/ParSim/docs/material-data/">Material data</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Biswajit Banerjee</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>PhD Mechanical Engineering</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Auckland, NZ</span>
        </li>
      

      
        
          
            <li><a href="mailto:b.banerjee.nz@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Parallel domain decomposition for particle methods: Part 3">
    <meta itemprop="description" content="IntroductionIn Part 2 of this serieswe showed the direct way of communicating ghost particles between patches.  That approachrequires 26 communication steps per patch in three-dimensions.  In this article we discussthe approach suggested by Steve Plimpton (“Fast parallel algorithms for short-range molecular dynamics”, Sandia Report SAND91-1144.UC-405, 1993).">
    <meta itemprop="datePublished" content="2017-07-23T22:30:00+12:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Parallel domain decomposition for particle methods: Part 3
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          16 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#plimptons-scheme-for-exchanging-particles">Plimpton’s scheme for exchanging particles</a></li>
  <li><a href="#mpi-implementation">MPI implementation</a>
    <ul>
      <li><a href="#patch-struct">Patch struct</a></li>
      <li><a href="#the-particle-exchange-function">The particle exchange function</a></li>
    </ul>
  </li>
  <li><a href="#remarks">Remarks</a></li>
</ul>

            </nav>
          </aside>
        
        <h4 id="introduction">Introduction</h4>
<p>In <a href="/ParSim/mpi/c++/parallel-domain-decomposition-part-2/">Part 2</a> of this series
we showed the direct way of communicating ghost particles between patches.  That approach
requires 26 communication steps per patch in three-dimensions.  In this article we discuss
the approach suggested by Steve Plimpton (“Fast parallel algorithms for short-range molecular 
dynamics”, Sandia Report SAND91-1144.UC-405, 1993).
<!--more--></p>

<!--more-->
<p>Plimpton’s paper has been cited almost 15,000 times since its publication.  Among other
things, the paper explains how the number of communication steps can be reduced to six in
three dimensions.</p>

<h4 id="plimptons-scheme-for-exchanging-particles">Plimpton’s scheme for exchanging particles</h4>
<p>If you run the animation below, you will notice that the left-right ghost particles are
exchanged first.  The ghost regions in the up-down directions are then extended to include
the left-right ghost regions.  The particles in these enlarged regions are then transferred
in the up-down directions.  Therefore, there are only four communication steps in two-dimensions.
The same process can be used in three-dimensions, leading to only six communication steps.</p>

<div align="center" style="border:1px solid black">
<div>
  <input name="restartExchange" type="button" value="Exchange ghost particles" onclick="particlePlimpton.restartAnimation()" />
</div>
<div>
  <canvas id="particle-exchange-plimpton" height="500" width="500"></canvas>
</div>
</div>
<p />

<h4 id="mpi-implementation">MPI implementation</h4>
<p>In <a href="/ParSim/mpi/c++/parallel-domain-decomposition-part-2/">Part 2</a> we defined
a <code class="language-plaintext highlighter-rouge">PatchNeighborComm</code> struct and a <code class="language-plaintext highlighter-rouge">Patch</code> struct.  We can keep the <code class="language-plaintext highlighter-rouge">PatchNeighborComm</code>
struct in the same form, with the possible addition of a method of two.  However, the <code class="language-plaintext highlighter-rouge">Patch</code>
struct becomes considerably simplified as show below.</p>

<h5 id="patch-struct">Patch struct</h5>
<p>The <code class="language-plaintext highlighter-rouge">Patch</code> struct now needs only six <code class="language-plaintext highlighter-rouge">PatchNeighborComm</code> objects but three <code class="language-plaintext highlighter-rouge">waitToFinish</code>
and <code class="language-plaintext highlighter-rouge">combineReceivedParticles</code> methods.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="nc">Patch</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">d_rank</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">d_ghostWidth</span><span class="p">,</span> <span class="n">d_tolerance</span><span class="p">;</span>
  <span class="n">IntVec</span> <span class="n">d_patchMPICoords</span><span class="p">;</span>
  <span class="n">Vec</span> <span class="n">d_lower</span><span class="p">,</span> <span class="n">d_upper</span><span class="p">;</span>
  <span class="n">PatchNeighborComm</span> <span class="n">d_xMinus</span><span class="p">,</span> <span class="n">d_yMinus</span><span class="p">,</span> <span class="n">d_zMinus</span><span class="p">,</span> <span class="n">d_xPlus</span><span class="p">,</span> <span class="n">d_yPlus</span><span class="p">,</span> <span class="n">d_zPlus</span><span class="p">;</span>
  <span class="n">Patch</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">,</span>
        <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="k">const</span> <span class="n">IntVec</span><span class="o">&amp;</span> <span class="n">mpiCoords</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vec</span><span class="o">&amp;</span> <span class="n">lower</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vec</span><span class="o">&amp;</span> <span class="n">upper</span><span class="p">,</span>
        <span class="kt">double</span> <span class="n">ghostWidth</span><span class="p">,</span> <span class="kt">double</span> <span class="n">tolerance</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">setXMinus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">);</span> <span class="c1">// A patch boundary is at the domain boundary</span>
  <span class="kt">void</span> <span class="n">setXPlus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">setYMinus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">);</span>
  <span class="c1">// .....</span>
  <span class="kt">void</span> <span class="n">setZPlus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">);</span>
  <span class="c1">// Step 1: Send and receive data from x+ and x-</span>
  <span class="kt">void</span> <span class="n">sendRecvGhostXMinus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">sendRecvGhostXPlus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">waitToFinishX</span><span class="p">();</span>
  <span class="kt">void</span> <span class="n">combineReceivedParticlesX</span><span class="p">(</span><span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">);</span>
  <span class="c1">// Step 2: Send and receive data from y+ and y-</span>
  <span class="kt">void</span> <span class="n">sendRecvGhostYMinus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">sendRecvGhostYPlus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">waitToFinishY</span><span class="p">();</span>
  <span class="kt">void</span> <span class="n">combineReceivedParticlesY</span><span class="p">(</span><span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">);</span>
  <span class="c1">// Step 3: Send and receive data from z+ and z-</span>
  <span class="kt">void</span> <span class="n">sendRecvGhostZMinus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">sendRecvGhostZPlus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">waitToFinishZ</span><span class="p">();</span>
  <span class="kt">void</span> <span class="n">combineReceivedParticlesZ</span><span class="p">(</span><span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">);</span>
<span class="p">};</span></code></pre></figure>

<p>The new implementation of the <code class="language-plaintext highlighter-rouge">Patch</code> struct is shown below.  The initialization of
the struct is the same as before; as are the <code class="language-plaintext highlighter-rouge">setXMinus</code> etc. methods.  Also, the
<code class="language-plaintext highlighter-rouge">sendRecvGhostXMinus</code> and <code class="language-plaintext highlighter-rouge">sendRecvGhostXPlus</code> methods are the same as before.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">Patch</span><span class="o">::</span><span class="n">Patch</span><span class="p">(</span><span class="c1">//...) {</span>
  <span class="c1">//.....  Same as for direct communication</span>
<span class="err">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">setXMinus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//.....  Same as for direct communication</span>
<span class="p">}</span>
<span class="c1">//......</span></code></pre></figure>

<p>Next we do the communication of the x+ and x- neighbors and combine the
received particles with the particles in the current patch.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="c1">// Step 1:  Do the x+ and x- communication</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">sendRecvGhostXMinus</span><span class="p">(</span><span class="c1">//....) {</span>
  <span class="c1">//.....  Same as for direct communication</span>
<span class="err">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">sendRecvGhostXPlus</span><span class="p">(</span><span class="c1">//....) {</span>
  <span class="c1">//.....  Same as for direct communication</span>
<span class="err">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">waitToFinishX</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_xMinus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d_xMinus</span><span class="p">.</span><span class="n">waitToFinish</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_xPlus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d_xPlus</span><span class="p">.</span><span class="n">waitToFinish</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">combineReceivedParticlesX</span><span class="p">(</span><span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">received</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">d_xMinus</span><span class="p">.</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">patchParticles</span><span class="p">);</span>
  <span class="n">d_xPlus</span><span class="p">.</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">patchParticles</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Now that the <code class="language-plaintext highlighter-rouge">patchParticles</code> vector has been updated, we can repeat the
process for the y+ and y- directions.  Note that the size of the ghost
region has been expanded in the negative and positive x-direction.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="c1">// Step 2:  Do the y+ and y- communication</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">sendRecvGhostYMinus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span> <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_yMinus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span> 
    <span class="n">Vec</span> <span class="n">ghostLower</span> <span class="o">=</span> <span class="n">d_lower</span> <span class="o">-</span> <span class="n">Vec</span><span class="p">(</span><span class="n">d_ghostWidth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="n">Vec</span> <span class="n">ghostUpper</span> <span class="o">=</span> <span class="n">d_upper</span> <span class="o">+</span> <span class="n">Vec</span><span class="p">(</span><span class="n">d_ghostWidth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="n">ghostUpper</span><span class="p">.</span><span class="n">setY</span><span class="p">(</span><span class="n">d_lower</span><span class="p">.</span><span class="n">y</span><span class="p">()</span> <span class="o">+</span> <span class="n">d_ghostWidth</span><span class="p">);</span>
    <span class="n">Box</span> <span class="n">ghostBox</span><span class="p">(</span><span class="n">ghostLower</span><span class="p">,</span> <span class="n">ghostUpper</span><span class="p">);</span>
    <span class="n">d_yMinus</span><span class="p">.</span><span class="n">asyncSendRecv</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">ghostBox</span><span class="p">,</span> <span class="n">d_tolerance</span><span class="p">,</span> <span class="n">patchParticles</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">sendRecvGhostYPlus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span> <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_yPlus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Vec</span> <span class="n">ghostLower</span> <span class="o">=</span> <span class="n">d_lower</span> <span class="o">-</span> <span class="n">Vec</span><span class="p">(</span><span class="n">d_ghostWidth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="n">ghostLower</span><span class="p">.</span><span class="n">setY</span><span class="p">(</span><span class="n">d_upper</span><span class="p">.</span><span class="n">y</span><span class="p">()</span> <span class="o">-</span> <span class="n">d_ghostWidth</span><span class="p">);</span>
    <span class="n">Vec</span> <span class="n">ghostUpper</span> <span class="o">=</span> <span class="n">d_upper</span> <span class="o">+</span> <span class="n">Vec</span><span class="p">(</span><span class="n">d_ghostWidth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="n">Box</span> <span class="n">ghostBox</span><span class="p">(</span><span class="n">ghostLower</span><span class="p">,</span> <span class="n">ghostUpper</span><span class="p">);</span>
    <span class="n">d_yPlus</span><span class="p">.</span><span class="n">asyncSendRecv</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">ghostBox</span><span class="p">,</span> <span class="n">d_tolerance</span><span class="p">,</span> <span class="n">patchParticles</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">waitToFinishY</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_yMinus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d_yMinus</span><span class="p">.</span><span class="n">waitToFinish</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_yPlus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d_yPlus</span><span class="p">.</span><span class="n">waitToFinish</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">combineReceivedParticlesY</span><span class="p">(</span><span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">received</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">d_yMinus</span><span class="p">.</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">patchParticles</span><span class="p">);</span>
  <span class="n">d_yPlus</span><span class="p">.</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">patchParticles</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>Finally, we do the third stage of communication in the z-direction.  The ghost-regions
have now been expanded to contain for the x-, x+ and y-, y+ extensions.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="c1">// Step 2:  Do the z+ and z- communication</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">sendRecvGhostZMinus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span> <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_zMinus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Vec</span> <span class="n">ghostLower</span> <span class="o">=</span> <span class="n">d_lower</span> <span class="o">-</span> <span class="n">Vec</span><span class="p">(</span><span class="n">d_ghostWidth</span><span class="p">,</span> <span class="n">d_ghostWidth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="n">Vec</span> <span class="n">ghostUpper</span> <span class="o">=</span> <span class="n">d_upper</span> <span class="o">+</span> <span class="n">Vec</span><span class="p">(</span><span class="n">d_ghostWidth</span><span class="p">,</span> <span class="n">d_ghostWidth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="n">ghostUpper</span><span class="p">.</span><span class="n">setZ</span><span class="p">(</span><span class="n">d_lower</span><span class="p">.</span><span class="n">z</span><span class="p">()</span> <span class="o">+</span> <span class="n">d_ghostWidth</span><span class="p">);</span>
    <span class="n">Box</span> <span class="n">ghostBox</span><span class="p">(</span><span class="n">ghostLower</span><span class="p">,</span> <span class="n">ghostUpper</span><span class="p">);</span>
    <span class="n">d_zMinus</span><span class="p">.</span><span class="n">asyncSendRecv</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">ghostBox</span><span class="p">,</span> <span class="n">d_tolerance</span><span class="p">,</span> <span class="n">patchParticles</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">sendRecvGhostZPlus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span> <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_zPlus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Vec</span> <span class="n">ghostLower</span> <span class="o">=</span> <span class="n">d_lower</span> <span class="o">-</span> <span class="n">Vec</span><span class="p">(</span><span class="n">d_ghostWidth</span><span class="p">,</span> <span class="n">d_ghostWidth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="n">ghostLower</span><span class="p">.</span><span class="n">setZ</span><span class="p">(</span><span class="n">d_upper</span><span class="p">.</span><span class="n">z</span><span class="p">()</span> <span class="o">-</span> <span class="n">d_ghostWidth</span><span class="p">);</span>
    <span class="n">Vec</span> <span class="n">ghostUpper</span> <span class="o">=</span> <span class="n">d_upper</span> <span class="o">+</span> <span class="n">Vec</span><span class="p">(</span><span class="n">d_ghostWidth</span><span class="p">,</span> <span class="n">d_ghostWidth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
    <span class="n">Box</span> <span class="n">ghostBox</span><span class="p">(</span><span class="n">ghostLower</span><span class="p">,</span> <span class="n">ghostUpper</span><span class="p">);</span>
    <span class="n">d_zPlus</span><span class="p">.</span><span class="n">asyncSendRecv</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">ghostBox</span><span class="p">,</span> <span class="n">d_tolerance</span><span class="p">,</span> <span class="n">patchParticles</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">waitToFinish</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_zMinus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d_zMinus</span><span class="p">.</span><span class="n">waitToFinish</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_zPlus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d_zPlus</span><span class="p">.</span><span class="n">waitToFinish</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">combineReceivedParticlesY</span><span class="p">(</span><span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">patchParticles</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">received</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">d_zMinus</span><span class="p">.</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">patchParticles</span><span class="p">);</span>
  <span class="n">d_zPlus</span><span class="p">.</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">patchParticles</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p />

<h5 id="the-particle-exchange-function">The particle exchange function</h5>
<p>The Plimpton particle exchange function the main simulation can then be simplified to
the following.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">ParticleCode</span><span class="o">::</span><span class="n">exchangeGhostParticles</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Initialize list of all particles in patch + ghost</span>
  <span class="n">mergeParticleVec</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">mergeParticleVec</span> <span class="o">=</span> <span class="n">particleVec</span><span class="p">;</span>
  <span class="c1">// First the x+/x- directions</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostXMinus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">mergeParticleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostXPlus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">mergeParticleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">waitToFinishX</span><span class="p">();</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">combineReceivedParticlesX</span><span class="p">(</span><span class="n">mergeParticleVec</span><span class="p">);</span>
  <span class="c1">// Next the y+/y- directions</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostYMinus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">mergeParticleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostYPlus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">mergeParticleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">waitToFinishX</span><span class="p">();</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">combineReceivedParticlesX</span><span class="p">(</span><span class="n">mergeParticleVec</span><span class="p">);</span>
  <span class="c1">// Next the z+/z- directions</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostZMinus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">mergeParticleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostZPlus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">mergeParticleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">waitToFinishX</span><span class="p">();</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">combineReceivedParticlesX</span><span class="p">(</span><span class="n">mergeParticleVec</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>In this case the number of communication steps is much smaller.  However, there is a wait period
at the end of each communication step that may reduce the benefits of the Plimpton approach
in some situations where the particles are unevenly distributed.</p>

<h4 id="remarks">Remarks</h4>
<p>Plimpton’s scheme is attractive for its simplicity in communicating ghost particle positions.
However, there are two more important communication steps that need to be considered - the
computation of interparticle forces and the migration of particles between patches.  In the next
part of this series, we will discuss the migration of particles when we use the Plimpton scheme.</p>

<script src="/ParSim/assets/js/d3.v4.min.js"></script>

<script src="/ParSim/assets/js/colorbrewer.min.js"></script>

<script src="/ParSim/assets/js/particlePlimpton.js"></script>


        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/ParSim/categories/#c" class="page__taxonomy-item" rel="tag">C++</a><span class="sep">, </span>
    
      
      
      <a href="/ParSim/categories/#mpi" class="page__taxonomy-item" rel="tag">MPI</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-07-23T22:30:00+12:00">July 23, 2017</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Parallel+domain+decomposition+for+particle+methods%3A+Part+3%20https%3A%2F%2Fbbanerjee.github.io%2FParSim%2Fmpi%2Fc%2B%2B%2Fparallel-domain-decomposition-part-3%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fbbanerjee.github.io%2FParSim%2Fmpi%2Fc%2B%2B%2Fparallel-domain-decomposition-part-3%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fbbanerjee.github.io%2FParSim%2Fmpi%2Fc%2B%2B%2Fparallel-domain-decomposition-part-3%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ParSim/mpi/c++/parallel-domain-decomposition-part-2/" class="pagination--pager" title="Parallel domain decomposition for particle methods: Part 2
">Previous</a>
    
    
      <a href="/ParSim/mpi/c++/parallel-domain-decomposition-part-4/" class="pagination--pager" title="Parallel domain decomposition for particle methods: Part 4
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/fem/cracks/python/salome-meca/code-aster/inspecting-and-manipulating-meshes/" rel="permalink">Inspecting and manipulating meshes in Salome-Meca for Code-Aster
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          30 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">In this article, I will discuss how elements can be selected from deep inside a 3D mesh
in the Salome-Meca environment and manipulated with Python scripts.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/vaango/compiling-vaango-on-a-cray/" rel="permalink">Compiling and running the MPM code Vaango on a Cray
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          16 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction

One of the reasons I switched to cmake for my builds was the need to compile my
Vaango code on a BlueGene/Q system.  The code was previously co...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/mpi/c++/mpi-unit-testing-googletests-cmake/" rel="permalink">Unit testing with MPI, googletest, and cmake
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          22 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction
In this article we take a short detour into the problem of continuous unit testing
of code that contains MPI calls and use either mpich
or Open ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/mpi/c++/parallel-domain-decomposition-part-4/" rel="permalink">Parallel domain decomposition for particle methods: Part 4
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          13 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction
The Plimpton scheme of communicating ghost information between patches was described
in Part 3 of this series.
Let us now see how a similar appr...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
    

    <li><a href="/ParSim/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Biswajit Banerjee. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/ParSim/assets/js/main.min.js"></script>










  </body>
</html>
