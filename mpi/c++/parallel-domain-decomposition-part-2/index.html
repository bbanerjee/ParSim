<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.21.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Parallel domain decomposition for particle methods: Part 2 - Parresia Simulations</title>
<meta name="description" content="Communicating ghost regions the direct way">


  <meta name="author" content="Biswajit Banerjee">
  
  <meta property="article:author" content="Biswajit Banerjee">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Parresia Simulations">
<meta property="og:title" content="Parallel domain decomposition for particle methods: Part 2">
<meta property="og:url" content="http://localhost:4000/ParSim/mpi/c++/parallel-domain-decomposition-part-2/">


  <meta property="og:description" content="Communicating ghost regions the direct way">







  <meta property="article:published_time" content="2017-07-22T22:30:00+12:00">





  

  


<link rel="canonical" href="http://localhost:4000/ParSim/mpi/c++/parallel-domain-decomposition-part-2/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Biswajit Banerjee",
      "url": "http://localhost:4000/ParSim/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/ParSim/feed.xml" type="application/atom+xml" rel="alternate" title="Parresia Simulations Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/ParSim/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_HTMLorMML">
  </script>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/ParSim/"><img src="/ParSim/assets/img/ParresiaLogoSep2017_plain.png" alt=""></a>
        
        <a class="site-title" href="/ParSim/">
          Parresia Simulations
          <span class="site-subtitle">Parallel particle and finite element simulation</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/ParSim/docs/articles/">Blog articles</a>
            </li><li class="masthead__menu-item">
              <a href="/ParSim/docs/parsim/">ParSim software</a>
            </li><li class="masthead__menu-item">
              <a href="/ParSim/docs/material-data/">Material data</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Biswajit Banerjee</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>PhD Mechanical Engineering</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Auckland, NZ</span>
        </li>
      

      
        
          
            <li><a href="mailto:b.banerjee.nz@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Parallel domain decomposition for particle methods: Part 2">
    <meta itemprop="description" content="IntroductionThe previous article in this seriesdiscussed the scatter operation for moving particles to various processes.  In this second partof the series we will discuss a commonly used method of communicating information betweenprocesses.  Each process is logically mapped to a “patch”.">
    <meta itemprop="datePublished" content="2017-07-22T22:30:00+12:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Parallel domain decomposition for particle methods: Part 2
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          14 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#exchanging-particles-between-processes">Exchanging particles between processes</a></li>
  <li><a href="#mpi-implementation">MPI implementation</a>
    <ul>
      <li><a href="#patchneighborcomm-struct">PatchNeighborComm struct</a></li>
      <li><a href="#patch-struct">Patch struct</a></li>
      <li><a href="#the-particle-exchange-function">The particle exchange function</a></li>
    </ul>
  </li>
  <li><a href="#remarks">Remarks</a></li>
</ul>

            </nav>
          </aside>
        
        <h4 id="introduction">Introduction</h4>
<p>The <a href="/ParSim/mpi/c++/parallel-domain-decomposition-part-1/">previous article</a> in this series
discussed the scatter operation for moving particles to various processes.  In this second part
of the series we will discuss a commonly used method of communicating information between
processes.  Each process is logically mapped to a “patch”.
<!--more--></p>

<p>In the animation below, particles are generated in the red patch “P0” and then scattered
to the other eight patches.  During a particle-based simulation, some information has to
be transferred between adjacent processes.  The amount of information that has to be
communicated depends on a characteristic length scale that is determined by the particle
algorithm.  In the animation, this length is shown by the “ghost” regions outlined in
a darker shade with dashed borders.</p>

<div align="center" style="border:1px solid black">
<div>
  <input name="restartScatter" type="button" value="Scatter particles" onclick="particleScatterGhost.restartAnimation()" />
</div>
<div>
  <canvas id="particle-scatter-ghost" height="500" width="500"></canvas>
</div>
</div>
<p />

<h4 id="exchanging-particles-between-processes">Exchanging particles between processes</h4>
<p>After the particles have been scattered and ghost regions identified, the particles in
the ghost regions are exchanged as depicted in the animation below.  Notice that, in
addition to the exchange between the left-right and top-bottom patches, the information
at corners of patches also have to communicated to the three adjacent patches for a total
of 8 communication steps. For three-dimensional simulations, 26 such communication steps
are needed for each patch. Also notice that all we are doing is increasing the size of
each patch and including regions of overlap between patches.</p>

<div align="center" style="border:1px solid black">
<div>
  <input name="restartExchange" type="button" value="Exchange ghost particles" onclick="particleExchange.restartAnimation()" />
</div>
<div>
  <canvas id="particle-exchange-ghost" height="500" width="500"></canvas>
</div>
</div>
<p />

<h4 id="mpi-implementation">MPI implementation</h4>
<p>To keep things manageable, we create a <code class="language-plaintext highlighter-rouge">PatchNeighborComm</code> struct for communications
between neighbor patches. We also define a <code class="language-plaintext highlighter-rouge">Patch</code> struct that takes care of the details for each patch.</p>

<h5 id="patchneighborcomm-struct">PatchNeighborComm struct</h5>
<p>The neighbor communication methods are defined as:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">enum</span> <span class="k">class</span> <span class="nc">PatchBoundary</span> <span class="o">:</span> <span class="kt">char</span> <span class="p">{</span>
  <span class="n">xminus</span><span class="p">,</span> <span class="n">xplus</span><span class="p">,</span> <span class="n">yminus</span><span class="p">,</span> <span class="n">yplus</span><span class="p">,</span> <span class="n">zminus</span><span class="p">,</span> <span class="n">zplus</span><span class="p">,</span> <span class="n">inside</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="nc">PatchNeighborComm</span> <span class="p">{</span>
  <span class="n">PatchBoundary</span> <span class="n">d_boundary</span><span class="p">;</span>   <span class="c1">// Whether the patch has a neighbor</span>
  <span class="kt">int</span> <span class="n">d_rank</span><span class="p">;</span>                 <span class="c1">// Rank of the neighbor</span>
  <span class="kt">int</span> <span class="n">d_mpiTag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">request</span> <span class="n">d_sendRecvReq</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="n">ParticlePArray</span> <span class="n">d_sentParticles</span><span class="p">;</span> <span class="c1">// For sends to neighbor</span>
  <span class="n">ParticlePArray</span> <span class="n">d_recvParticles</span><span class="p">;</span> <span class="c1">// For receives from neighbor</span>
  <span class="kt">void</span> <span class="n">setNeighbor</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">myRank</span><span class="p">,</span>
                   <span class="k">const</span> <span class="n">IntVec</span><span class="o">&amp;</span> <span class="n">neighborCoords</span><span class="p">,</span>
                   <span class="n">PatchBoundary</span> <span class="n">boundaryFlag</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">asyncSendRecv</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                     <span class="kt">int</span> <span class="n">myRank</span><span class="p">,</span> <span class="k">const</span> <span class="n">Box</span><span class="o">&amp;</span> <span class="n">box</span><span class="p">,</span> <span class="k">const</span> <span class="kt">double</span><span class="o">&amp;</span> <span class="n">tolerance</span><span class="p">,</span>
                     <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">findParticlesInBox</span><span class="p">(</span><span class="k">const</span> <span class="n">Box</span><span class="o">&amp;</span> <span class="n">box</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">,</span>
                          <span class="k">const</span> <span class="kt">double</span><span class="o">&amp;</span> <span class="n">tolerance</span><span class="p">,</span>
                          <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">inside</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">waitToFinish</span><span class="p">(</span><span class="kt">int</span> <span class="n">myRank</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">combineReceivedParticles</span><span class="p">(</span><span class="kt">int</span> <span class="n">myRank</span><span class="p">,</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">received</span><span class="p">);</span>
<span class="p">};</span></code></pre></figure>

<p>An implementation of the functions in this struct is shown below:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">PatchNeighborComm</span><span class="o">::</span><span class="n">setNeighbor</span><span class="p">(</span><span class="c1">//....) {</span>
  <span class="kt">int</span> <span class="n">neighborRank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">MPI_Cart_rank</span><span class="p">(</span><span class="n">cartComm</span><span class="p">,</span> <span class="n">neighborCoords</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">neighborRank</span><span class="p">);</span>
  <span class="n">d_rank</span> <span class="o">=</span> <span class="n">neighborRank</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">neighborRank</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d_boundary</span> <span class="o">=</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">d_boundary</span> <span class="o">=</span> <span class="n">boundaryFlag</span><span class="p">;</span>
  <span class="p">}</span>
<span class="err">}</span>
<span class="kt">void</span> <span class="n">PatchNeighborComm</span><span class="o">::</span><span class="n">asyncSendRecv</span><span class="p">(</span><span class="c1">//...) {</span>
  <span class="c1">// Find the particles in the ghost box</span>
  <span class="n">findParticlesInBox</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">particles</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">,</span> <span class="n">d_sentParticles</span><span class="p">);</span>
  <span class="c1">// Asynchronous send</span>
  <span class="n">d_sendRecvReq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">boostWorld</span><span class="p">.</span><span class="n">isend</span><span class="p">(</span><span class="n">d_rank</span><span class="p">,</span> <span class="n">d_mpiTag</span><span class="p">,</span> <span class="n">d_sentParticles</span><span class="p">);</span>
  <span class="c1">// Immediate asynchronous receive</span>
  <span class="n">d_sendRecvReq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">boostWorld</span><span class="p">.</span><span class="n">irecv</span><span class="p">(</span><span class="n">d_rank</span><span class="p">,</span> <span class="n">d_mpiTag</span><span class="p">,</span> <span class="n">d_recvParticles</span><span class="p">);</span>
<span class="err">}</span>
<span class="kt">void</span> <span class="n">PatchNeighborComm</span><span class="o">::</span><span class="n">findParticlesInBox</span><span class="p">(</span><span class="c1">//...) { // Straightforward }</span>
<span class="kt">void</span> <span class="n">PatchNeighborComm</span><span class="o">::</span><span class="n">waitToFinish</span><span class="p">(</span><span class="c1">//...) {</span>
  <span class="c1">// Wait from processes to receive ghost data</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">wait_all</span><span class="p">(</span><span class="n">d_sendRecvReq</span><span class="p">,</span> <span class="n">d_sendRecvReq</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<span class="err">}</span>
<span class="kt">void</span> <span class="n">PatchNeighborComm</span><span class="o">::</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="c1">//...) {</span>
  <span class="n">received</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">d_recvParticles</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">d_recvParticles</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="err">}</span></code></pre></figure>

<h5 id="patch-struct">Patch struct</h5>
<p>The <code class="language-plaintext highlighter-rouge">Patch</code> struct takes care of all the communication needs of each patch.  The
definition I cobbled together is listed below.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="nc">Patch</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">d_rank</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">d_ghostWidth</span><span class="p">,</span> <span class="n">d_tolerance</span><span class="p">;</span>
  <span class="n">IntVec</span> <span class="n">d_patchMPICoords</span><span class="p">;</span>
  <span class="n">Vec</span> <span class="n">d_lower</span><span class="p">,</span> <span class="n">d_upper</span><span class="p">;</span>
  <span class="n">PatchNeighborComm</span> <span class="n">d_xMinus</span><span class="p">,</span> <span class="n">d_yMinus</span><span class="p">,</span> <span class="n">d_zMinus</span><span class="p">,</span> <span class="n">d_xPlus</span><span class="p">,</span> <span class="n">d_yPlus</span><span class="p">,</span> <span class="n">d_zPlus</span><span class="p">;</span>
  <span class="n">PatchNeighborComm</span> <span class="n">d_xMinus_yMinus</span><span class="p">,</span> <span class="n">d_xMinus_yPlus</span><span class="p">,</span> <span class="n">d_xPlus_yMinus</span><span class="p">,</span> <span class="n">d_xPlus_yPlus</span><span class="p">;</span>
  <span class="n">PatchNeighborComm</span> <span class="n">d_xMinus_zMinus</span><span class="p">,</span> <span class="n">d_xMinus_zPlus</span><span class="p">,</span> <span class="n">d_xPlus_zMinus</span><span class="p">,</span> <span class="n">d_xPlus_zPlus</span><span class="p">;</span>
  <span class="n">PatchNeighborComm</span> <span class="n">d_yMinus_zMinus</span><span class="p">,</span> <span class="n">d_yMinus_zPlus</span><span class="p">,</span> <span class="n">d_yPlus_zMinus</span><span class="p">,</span> <span class="n">d_yPlus_zPlus</span><span class="p">;</span>
  <span class="n">PatchNeighborComm</span> <span class="n">d_xMinus_yMinus_zMinus</span><span class="p">,</span> <span class="n">d_xMinus_yPlus_zMinus</span><span class="p">,</span> <span class="n">d_xPlus_yMinus_zMinus</span><span class="p">,</span> <span class="n">d_xPlus_yPlus_zMinus</span><span class="p">;</span>
  <span class="n">PatchNeighborComm</span> <span class="n">d_xMinus_yMinus_zPlus</span><span class="p">,</span> <span class="n">d_xMinus_yPlus_zPlus</span><span class="p">,</span> <span class="n">d_xPlus_yMinus_zPlus</span><span class="p">,</span> <span class="n">d_xPlus_yPlus_zPlus</span><span class="p">;</span>
  <span class="n">Patch</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">,</span>
        <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="k">const</span> <span class="n">IntVec</span><span class="o">&amp;</span> <span class="n">mpiCoords</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vec</span><span class="o">&amp;</span> <span class="n">lower</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vec</span><span class="o">&amp;</span> <span class="n">upper</span><span class="p">,</span>
        <span class="kt">double</span> <span class="n">ghostWidth</span><span class="p">,</span> <span class="kt">double</span> <span class="n">tolerance</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">setXMinus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">);</span> <span class="c1">// A patch boundary is at the domain boundary</span>
  <span class="kt">void</span> <span class="n">setXPlus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">setYMinus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">);</span>
  <span class="c1">// .....</span>
  <span class="kt">void</span> <span class="n">setZPlus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">sendRecvGhostXMinus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">sendRecvGhostXPlus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">sendRecvGhostYMinus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="c1">// .....</span>
  <span class="kt">void</span> <span class="n">sendRecvGhostZPlus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="c1">// .....</span>
  <span class="kt">void</span> <span class="n">sendRecvGhostXMinusYMinus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                                 <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="c1">// .....</span>
  <span class="kt">void</span> <span class="n">sendRecvGhostXMinusYMinusZminus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="c1">// .....</span>
  <span class="kt">void</span> <span class="n">sendRecvGhostXPlusYPlusZPlus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                                    <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">waitToFinish</span><span class="p">();</span>
  <span class="kt">void</span> <span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">received</span><span class="p">);</span>
<span class="p">};</span></code></pre></figure>

<p>The implementation of the <code class="language-plaintext highlighter-rouge">Patch</code> struct that I came up with is summarized below.
The design can definitely be improved; but recall that our goal is to do a quick
parallelization of an existing serial code.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">Patch</span><span class="o">::</span><span class="n">Patch</span><span class="p">(</span><span class="c1">//...) {</span>
 <span class="n">d_rank</span> <span class="o">=</span> <span class="n">rank</span><span class="p">;</span>
 <span class="c1">//.....</span>
 <span class="n">setXPlus</span><span class="p">(</span><span class="n">cartComm</span><span class="p">);</span>
 <span class="c1">//.....</span>
 <span class="n">setZPlus</span><span class="p">(</span><span class="n">cartComm</span><span class="p">);</span>
<span class="err">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">setXMinus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">IntVec</span> <span class="n">neighborCoords</span> <span class="o">=</span> <span class="n">d_patchMPICoords</span><span class="p">;</span>
  <span class="o">--</span><span class="n">neighborCoords</span><span class="p">.</span><span class="n">x</span><span class="p">();</span>
  <span class="n">d_xMinus</span><span class="p">.</span><span class="n">setNeighbor</span><span class="p">(</span><span class="n">cartComm</span><span class="p">,</span> <span class="n">d_rank</span><span class="p">,</span> <span class="n">neighborCoords</span><span class="p">,</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">xminus</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">//......</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">setZPlus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">IntVec</span> <span class="n">neighborCoords</span> <span class="o">=</span> <span class="n">d_patchMPICoords</span><span class="p">;</span>
  <span class="o">++</span><span class="n">neighborCoords</span><span class="p">.</span><span class="n">z</span><span class="p">();</span>
  <span class="n">d_zPlus</span><span class="p">.</span><span class="n">setNeighbor</span><span class="p">(</span><span class="n">cartComm</span><span class="p">,</span> <span class="n">d_rank</span><span class="p">,</span> <span class="n">neighborCoords</span><span class="p">,</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">zplus</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">sendRecvGhostXMinus</span><span class="p">(</span><span class="c1">//....) {</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_xMinus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Vec</span> <span class="n">ghostLower</span> <span class="o">=</span> <span class="n">d_lower</span><span class="p">;</span>
    <span class="n">Vec</span> <span class="n">ghostUpper</span> <span class="o">=</span> <span class="n">d_upper</span><span class="p">;</span>
    <span class="n">ghostUpper</span><span class="p">.</span><span class="n">setX</span><span class="p">(</span><span class="n">d_lower</span><span class="p">.</span><span class="n">x</span><span class="p">()</span> <span class="o">+</span> <span class="n">d_ghostWidth</span><span class="p">);</span>
    <span class="n">Box</span> <span class="n">ghostBox</span><span class="p">(</span><span class="n">ghostLower</span><span class="p">,</span> <span class="n">ghostUpper</span><span class="p">);</span>
    <span class="n">d_xMinus</span><span class="p">.</span><span class="n">asyncSendRecv</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">d_rank</span><span class="p">,</span> <span class="n">ghostBox</span><span class="p">,</span> <span class="n">d_tolerance</span><span class="p">,</span> <span class="n">particles</span><span class="p">);</span>
  <span class="p">}</span>
<span class="err">}</span>
<span class="c1">//......</span>
<span class="c1">//......</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">sendRecvGhostXPlusYPlusZPlus</span><span class="p">(</span><span class="c1">//....) {</span>
<span class="c1">//......</span>
<span class="err">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">waitToFinish</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_xMinus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d_xMinus</span><span class="p">.</span><span class="n">waitToFinish</span><span class="p">(</span><span class="n">d_rank</span><span class="p">,</span> <span class="n">iteration</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_xPlus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d_xPlus</span><span class="p">.</span><span class="n">waitToFinish</span><span class="p">(</span><span class="n">d_rank</span><span class="p">,</span> <span class="n">iteration</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">//.....</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">received</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">received</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">d_xMinus</span><span class="p">.</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">d_rank</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">received</span><span class="p">);</span>
  <span class="n">d_xPlus</span><span class="p">.</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">d_rank</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">received</span><span class="p">);</span>
  <span class="c1">//.....</span>
<span class="p">}</span></code></pre></figure>

<p />

<h5 id="the-particle-exchange-function">The particle exchange function</h5>
<p>The particle exchange function the main simulation code can then be written as follows.
Note that this design follows the approach taken by Dr. B. Yan for his parallel DEM code
developed a UC Boulder.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">void</span>
<span class="n">ParticleCode</span><span class="o">::</span><span class="n">exchangeGhostParticles</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostXMinus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostXPlus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostYMinus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostYPlus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostZMinus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostZPlus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="c1">//.....</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostXPlusYPlusZPlus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">waitToFinish</span><span class="p">();</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">recvParticleVec</span><span class="p">);</span>
  <span class="n">mergeParticleVec</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">mergeParticleVec</span> <span class="o">=</span> <span class="n">particleVec</span><span class="p">;</span>
  <span class="n">mergeParticleVec</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mergeParticleVec</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">recvParticleVec</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
                          <span class="n">recvParticleVec</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>Clearly, a lot of communication and book-keeping is needed if we follow this approach.  An
alternative approach that uses fewer communication steps is the procedure developed by
Steve Plimpton (“Fast parallel algorithms for short-range molecular dynamics”, Sandia Report
SAND91-1144.UC-405, 1993).</p>

<h4 id="remarks">Remarks</h4>
<p>In the next part of this series, we will discuss Plimpton’s approach for domain decomposition.</p>

<script src="/ParSim/assets/js/d3.v4.min.js"></script>

<script src="/ParSim/assets/js/colorbrewer.min.js"></script>

<script src="/ParSim/assets/js/particleScatterGhost.js"></script>

<script src="/ParSim/assets/js/particleExchange.js"></script>


        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/ParSim/categories/#c" class="page__taxonomy-item" rel="tag">C++</a><span class="sep">, </span>
    
      
      
      <a href="/ParSim/categories/#mpi" class="page__taxonomy-item" rel="tag">MPI</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-07-22T22:30:00+12:00">July 22, 2017</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Parallel+domain+decomposition+for+particle+methods%3A+Part+2%20http%3A%2F%2Flocalhost%3A4000%2FParSim%2Fmpi%2Fc%2B%2B%2Fparallel-domain-decomposition-part-2%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2FParSim%2Fmpi%2Fc%2B%2B%2Fparallel-domain-decomposition-part-2%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2FParSim%2Fmpi%2Fc%2B%2B%2Fparallel-domain-decomposition-part-2%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ParSim/mpi/c++/parallel-domain-decomposition-part-1/" class="pagination--pager" title="Parallel domain decomposition for particle methods: Part 1
">Previous</a>
    
    
      <a href="/ParSim/mpi/c++/parallel-domain-decomposition-part-3/" class="pagination--pager" title="Parallel domain decomposition for particle methods: Part 3
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/fem/cracks/python/salome-meca/code-aster/Modeling-cracks-in-Salome-Meca-and-Code-Aster/" rel="permalink">Modeling cracks in Salome-Meca and Code-Aster
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          7 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction
In Part 3 of this article I
discussed the approach where the equations for a system of rigid bodies are
approximated by a spring-mass system.  T...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/vaango/compiling-vaango-on-a-cray/" rel="permalink">Compiling and running the MPM code Vaango on a Cray
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          16 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction

One of the reasons I switched to cmake for my builds was the need to compile my
Vaango code on a BlueGene/Q system.  The code was previously co...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/mpi/c++/mpi-unit-testing-googletests-cmake/" rel="permalink">Unit testing with MPI, googletest, and cmake
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          22 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction
In this article we take a short detour into the problem of continuous unit testing
of code that contains MPI calls and use either mpich
or Open ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/mpi/c++/parallel-domain-decomposition-part-4/" rel="permalink">Parallel domain decomposition for particle methods: Part 4
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          13 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction
The Plimpton scheme of communicating ghost information between patches was described
in Part 3 of this series.
Let us now see how a similar appr...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
    

    <li><a href="/ParSim/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Biswajit Banerjee. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/ParSim/assets/js/main.min.js"></script>










  </body>
</html>
