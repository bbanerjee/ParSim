<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.21.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Unit testing with MPI, googletest, and cmake - Parresia Simulations</title>
<meta name="description" content="Continuous integration with make">


  <meta name="author" content="Biswajit Banerjee">
  
  <meta property="article:author" content="Biswajit Banerjee">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Parresia Simulations">
<meta property="og:title" content="Unit testing with MPI, googletest, and cmake">
<meta property="og:url" content="https://bbanerjee.github.io/ParSim/mpi/c++/mpi-unit-testing-googletests-cmake/">


  <meta property="og:description" content="Continuous integration with make">







  <meta property="article:published_time" content="2017-08-11T22:30:00+12:00">





  

  


<link rel="canonical" href="https://bbanerjee.github.io/ParSim/mpi/c++/mpi-unit-testing-googletests-cmake/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Biswajit Banerjee",
      "url": "https://bbanerjee.github.io/ParSim/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/ParSim/feed.xml" type="application/atom+xml" rel="alternate" title="Parresia Simulations Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/ParSim/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<link rel="stylesheet" href="https://bbanerjee.github.io/ParSim/assets/css/parresia.css">

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_HTMLorMML">
  </script>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/ParSim/"><img src="/ParSim/assets/img/ParresiaLogoSep2017_plain.png" alt=""></a>
        
        <a class="site-title" href="/ParSim/">
          Parresia Simulations
          <span class="site-subtitle">Parallel particle and finite element simulation</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/ParSim/docs/articles/">Blog articles</a>
            </li><li class="masthead__menu-item">
              <a href="/ParSim/docs/parsim/">ParSim software</a>
            </li><li class="masthead__menu-item">
              <a href="/ParSim/docs/material-data/">Material data</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Biswajit Banerjee</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>PhD Mechanical Engineering</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Auckland, NZ</span>
        </li>
      

      
        
          
            <li><a href="mailto:b.banerjee.nz@gmail.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Unit testing with MPI, googletest, and cmake">
    <meta itemprop="description" content="IntroductionIn this article we take a short detour into the problem of continuous unit testingof code that contains MPI calls and use either mpichor Open MPI.  I have recently moved fromCTest-based testing toa combination of CMake and googletest.  The reason for the shiftis the convenience googletestprovides.  However, the googletestprimerand advanced manualdo not contain many examples and can be cryptic at times.  I hope thisarticle will provide pointers to those who run into a roadblock when testing MPIapplications with googletest.">
    <meta itemprop="datePublished" content="2017-08-11T22:30:00+12:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Unit testing with MPI, googletest, and cmake
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          20 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#installing-googletest">Installing googletest</a></li>
  <li><a href="#making-sure-cmake-finds-and-compiles-googletest">Making sure cmake finds and compiles googletest</a></li>
  <li><a href="#adding-local-unit-tests">Adding local unit tests</a></li>
  <li><a href="#the-cmakeliststxt-file-in-unittests">The CMakeLists.txt file in UnitTests</a></li>
  <li><a href="#the-actual-test-c-code">The actual test C++ code</a>
    <ul>
      <li><a href="#the-mpi-test-environment-class">The MPI test environment class</a></li>
      <li><a href="#the-main-test-function">The main test function</a></li>
      <li><a href="#the-actual-test">The actual test</a></li>
      <li><a href="#caveat">Caveat</a></li>
    </ul>
  </li>
  <li><a href="#the-output-from-make">The output from make</a></li>
  <li><a href="#remarks">Remarks</a></li>
</ul>

            </nav>
          </aside>
        
        <h4 id="introduction">Introduction</h4>
<p>In this article we take a short detour into the problem of continuous unit testing
of code that contains MPI calls and use either <a href="https://www.mpich.org/">mpich</a>
or <a href="https://www.open-mpi.org/">Open MPI</a>.  I have recently moved from
<a href="https://cmake.org/Wiki/CMake/Testing_With_CTest">CTest-based testing</a> to
a combination of <a href="https://cmake.org/">CMake</a> and 
<a href="https://github.com/google/googletest">googletest</a>.  The reason for the shift
is the convenience <code class="language-plaintext highlighter-rouge">googletest</code>
provides.  However, the <code class="language-plaintext highlighter-rouge">googletest</code>
<a href="https://github.com/google/googletest/blob/master/googletest/docs/Primer.md">primer</a>
and <a href="https://github.com/google/googletest/blob/master/googletest/docs/AdvancedGuide.md">advanced manual</a>
do not contain many examples and can be cryptic at times.  I hope this
article will provide pointers to those who run into a roadblock when testing MPI
applications with <code class="language-plaintext highlighter-rouge">googletest</code>.
<!--more--></p>

<h4 id="installing-googletest">Installing googletest</h4>
<p>I typically install <code class="language-plaintext highlighter-rouge">googletest</code> as a <a href="https://git-scm.com/docs/git-submodule">submodule</a>
in my git repository.  For example,</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git submodule add git@github.com:google/googletest.git ./googletest</code></pre></figure>

<p>There are several <a href="https://chrisjean.com/git-submodules-adding-using-removing-and-updating/">caveats</a> 
when using git submodules.  For our purposes, we only have to remember that when we clone 
the repository we have to use</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">git clone <span class="nt">--recursive</span></code></pre></figure>

<p>Other tips can be found in a nicely condensed form in <a href="https://sentheon.com/blog/git-cheat-sheet.html#working-with-submodules">Sentheon’s blog</a>.</p>

<h4 id="making-sure-cmake-finds-and-compiles-googletest">Making sure cmake finds and compiles googletest</h4>
<p>To make sure that <code class="language-plaintext highlighter-rouge">googletest</code> can be found and is built during the compile process,
I add the following to by root <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> file:</p>

<figure class="highlight"><pre><code class="language-cmake" data-lang="cmake"><span class="nb">if</span> <span class="p">(</span>USE_CLANG<span class="p">)</span>
  <span class="nb">set</span><span class="p">(</span>CMAKE_CXX_COMPILER <span class="s2">"/usr/local/bin/clang++"</span><span class="p">)</span>
<span class="nb">endif</span> <span class="p">()</span>
<span class="nb">set</span><span class="p">(</span>gtest_force_shared_crt ON CACHE BOOL <span class="s2">""</span> FORCE<span class="p">)</span>
<span class="nb">add_subdirectory</span><span class="p">(</span>googletest<span class="p">)</span></code></pre></figure>

<p>The first line is needed because I have not been successful in passing the <code class="language-plaintext highlighter-rouge">clang</code> compiler
name to <code class="language-plaintext highlighter-rouge">googletest</code> without specifying the full path.  I’m sure one can use a more general
approach, but I haven’t felt the need to spend the time trying to figure out a better way.
The <code class="language-plaintext highlighter-rouge">add_subdirectory</code>	command is all that is needed for <code class="language-plaintext highlighter-rouge">cmake</code> to compile <code class="language-plaintext highlighter-rouge">googletest</code> and
produce static libraries.</p>

<h4 id="adding-local-unit-tests">Adding local unit tests</h4>
<p>Next I add a <code class="language-plaintext highlighter-rouge">UnitTests</code> directory in my directory of interest and modify the local
<code class="language-plaintext highlighter-rouge">CMakeLists.txt</code> to be able to find the <code class="language-plaintext highlighter-rouge">UnitTests</code> directory.  For example,</p>

<figure class="highlight"><pre><code class="language-cmake" data-lang="cmake"><span class="nf">SET</span><span class="p">(</span>SPH_SRCS
  <span class="si">${</span><span class="nv">CMAKE_CURRENT_SOURCE_DIR</span><span class="si">}</span>/SmoothParticleHydro.cpp
<span class="p">)</span>
<span class="nf">SET</span><span class="p">(</span>ELLIP3D_SRCS
  <span class="si">${</span><span class="nv">ELLIP3D_SRCS</span><span class="si">}</span>
  <span class="si">${</span><span class="nv">SPH_SRCS</span><span class="si">}</span>
  PARENT_SCOPE
<span class="p">)</span>
<span class="nb">add_subdirectory</span><span class="p">(</span>UnitTests<span class="p">)</span></code></pre></figure>

<p>In this case I am going to test my
<a href="https://en.wikipedia.org/wiki/Smoothed-particle_hydrodynamics">Smoothed Particle Hydrodynamics</a> code.</p>

<h4 id="the-cmakeliststxt-file-in-unittests">The CMakeLists.txt file in UnitTests</h4>
<p>Now we are finally really to add our unit tests to the build chain.  The <code class="language-plaintext highlighter-rouge">CMakeLists.txt</code>
file in the <code class="language-plaintext highlighter-rouge">UnitTests</code> directory has two sections (which can be simplified if you
are so inclined).</p>

<p>In the first section, we find the location of the <code class="language-plaintext highlighter-rouge">googletest</code> headers and libraries:</p>

<figure class="highlight"><pre><code class="language-cmake" data-lang="cmake"><span class="nb">set</span><span class="p">(</span>GTEST_INCLUDE_DIR <span class="s2">"</span><span class="si">${</span><span class="nv">CMAKE_SOURCE_DIR</span><span class="si">}</span><span class="s2">/googletest/googletest/include"</span><span class="p">)</span>
<span class="nb">set</span><span class="p">(</span>GTEST_LIB gtest_main gtest<span class="p">)</span>
<span class="nb">include_directories</span><span class="p">(</span><span class="si">${</span><span class="nv">GTEST_INCLUDE_DIR</span><span class="si">}</span><span class="p">)</span></code></pre></figure>

<p>Note that the two <code class="language-plaintext highlighter-rouge">googletest</code> libraries that we use are <code class="language-plaintext highlighter-rouge">gtest_main</code> and <code class="language-plaintext highlighter-rouge">gtest</code>.</p>

<p>In the second section, we add the actual test that requires <code class="language-plaintext highlighter-rouge">MPI</code>.  Once again, these details
can be abstracted into a <code class="language-plaintext highlighter-rouge">cmake</code> function if you so desire.</p>

<figure class="highlight"><pre><code class="language-cmake" data-lang="cmake"><span class="nb">add_executable</span><span class="p">(</span>testSPHParticleScatter testSPHParticleScatter.cpp<span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span>testSPHParticleScatter
  <span class="si">${</span><span class="nv">GTEST_LIB</span><span class="si">}</span>
  ellip3D_lib
  <span class="si">${</span><span class="nv">MPI_LIBRARY</span><span class="si">}</span>
  ....
<span class="p">)</span>
<span class="nb">set</span><span class="p">(</span>UNIT_TEST testSPHParticleScatter<span class="p">)</span>
<span class="nb">set</span><span class="p">(</span>MPI_COMMAND mpirun -np 2 <span class="si">${</span><span class="nv">UNIT_TEST</span><span class="si">}</span><span class="p">)</span>
<span class="nb">add_custom_command</span><span class="p">(</span>
  TARGET <span class="si">${</span><span class="nv">UNIT_TEST</span><span class="si">}</span>
  POST_BUILD
  COMMAND <span class="si">${</span><span class="nv">MPI_COMMAND</span><span class="si">}</span></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">add_executable</code> line identifies the unit test program <code class="language-plaintext highlighter-rouge">testSPHParticleScatter.cpp</code>
which tests the scatter operation between two MPI processes.</p>

<p>The <code class="language-plaintext highlighter-rouge">target_link_libraries</code> lists the libraries that are needed: the <code class="language-plaintext highlighter-rouge">googletest</code>
libraries (<code class="language-plaintext highlighter-rouge">GTEST_LIB</code>) and our coupled DEM-SPH code library (<code class="language-plaintext highlighter-rouge">ellip3D_lib</code>)</p>

<p>Then we set up a command to run (<code class="language-plaintext highlighter-rouge">MPI_COMMAND</code>) and make it use <code class="language-plaintext highlighter-rouge">mpirun</code>.  You
can generalize this if you want.</p>

<p>Finally we, add the <code class="language-plaintext highlighter-rouge">add_custom_command</code> line that tells <code class="language-plaintext highlighter-rouge">cmake</code> to run the <code class="language-plaintext highlighter-rouge">MPI_COMMAND</code>
after the build is complete (<code class="language-plaintext highlighter-rouge">POST_BUILD</code>).</p>

<h4 id="the-actual-test-c-code">The actual test C++ code</h4>
<p>Now that the build system has been configured, we just write our unit test
<code class="language-plaintext highlighter-rouge">testSPHParticleScatter.cpp</code>.</p>

<p>First, we include the required headers:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;SmoothParticleHydro/SmoothParticleHydro.h&gt;
#include &lt;gtest/gtest.h&gt;
#include &lt;boost/mpi.hpp&gt;</span></code></pre></figure>

<p>Note that we are using the <a href="http://www.boost.org/docs/libs/1_64_0/docs/html/mpi.html">Boost MPI</a> wrappers.</p>

<h5 id="the-mpi-test-environment-class">The MPI test environment class</h5>
<p>But we cannot use the <code class="language-plaintext highlighter-rouge">boost::mpi::environment</code> call to set up <code class="language-plaintext highlighter-rouge">MPI</code> (because the <code class="language-plaintext highlighter-rouge">environment</code>
object is deleted before <code class="language-plaintext highlighter-rouge">googletest</code>s are run).  Instead, we have to set up a custom environment
to run our <code class="language-plaintext highlighter-rouge">MPI</code> tests by creating a <code class="language-plaintext highlighter-rouge">MPIEnvironment</code> class that extends the <code class="language-plaintext highlighter-rouge">::testing::Environment</code>
class provided by <code class="language-plaintext highlighter-rouge">googletest</code>.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">MPIEnvironment</span> <span class="o">:</span> <span class="k">public</span> <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">Environment</span>
<span class="p">{</span>
<span class="nl">public:</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">SetUp</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">mpiError</span> <span class="o">=</span> <span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
    <span class="n">ASSERT_FALSE</span><span class="p">(</span><span class="n">mpiError</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">TearDown</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">mpiError</span> <span class="o">=</span> <span class="n">MPI_Finalize</span><span class="p">();</span>
    <span class="n">ASSERT_FALSE</span><span class="p">(</span><span class="n">mpiError</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">MPIEnvironment</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">};</span></code></pre></figure>

<p>Here, the <code class="language-plaintext highlighter-rouge">SetUp</code> function calls <code class="language-plaintext highlighter-rouge">MPI_Init</code> and sets up the environment while the <code class="language-plaintext highlighter-rouge">TearDown</code> function
calls ‘MPI_Finalize`.  All tests are performed when the environment is active.</p>

<h5 id="the-main-test-function">The <code class="language-plaintext highlighter-rouge">main</code> test function</h5>
<p>The <code class="language-plaintext highlighter-rouge">main</code> function in typically not needed in standard <code class="language-plaintext highlighter-rouge">googletest</code> tests and is generate
by some internal magic.  However, we do need a <code class="language-plaintext highlighter-rouge">main</code> function in <code class="language-plaintext highlighter-rouge">testSPHParticleScatter.cpp</code>
because we are using <code class="language-plaintext highlighter-rouge">mpirun</code> to run the test.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
  <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">InitGoogleTest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
  <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">AddGlobalTestEnvironment</span><span class="p">(</span><span class="k">new</span> <span class="n">MPIEnvironment</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">RUN_ALL_TESTS</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>The MPI specific environment is created by the <code class="language-plaintext highlighter-rouge">AddGlobalTestEnvironment</code> function to which we
pass a <code class="language-plaintext highlighter-rouge">MPIEnvironment</code> object.  The object is deleted internally by <code class="language-plaintext highlighter-rouge">googletest</code>.</p>

<p>The tests in <code class="language-plaintext highlighter-rouge">testSPHParticleScatter.cpp</code> are then run using <code class="language-plaintext highlighter-rouge">RUN_ALL_TESTS()</code>.  Note that this
function returns from <code class="language-plaintext highlighter-rouge">main</code> and, therefore, and non-googletest environment objects created in
main (e.g., with boost::mpi::environment) are deleted before the tests are run.</p>

<h5 id="the-actual-test">The actual test</h5>
<p>Finally, we add an actual test to <code class="language-plaintext highlighter-rouge">testSPHParticleScatter.cpp</code> as follows:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">TEST</span><span class="p">(</span><span class="n">SPHParticleScatterTest</span><span class="p">,</span> <span class="n">scatter</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Set up communicator</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span> <span class="n">boostWorld</span><span class="p">;</span>
  <span class="c1">// Set up SPH object</span>
  <span class="n">SmoothParticleHydro</span> <span class="n">sph</span><span class="p">;</span>
  <span class="n">sph</span><span class="p">.</span><span class="n">setCommunicator</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">);</span>
  <span class="c1">// ... Some code to create particles</span>
  <span class="c1">// ....</span>
  <span class="n">sph</span><span class="p">.</span><span class="n">setParticles</span><span class="p">(</span><span class="n">particles</span><span class="p">);</span>
  <span class="n">sph</span><span class="p">.</span><span class="n">scatterSPHParticle</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">ghostWidth</span><span class="p">,</span> <span class="n">domainBuffer</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">boostWorld</span><span class="p">.</span><span class="n">rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">sph</span><span class="p">.</span><span class="n">getSPHParticleVec</span><span class="p">().</span><span class="n">size</span><span class="p">(),</span> <span class="mi">100</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="n">sph</span><span class="p">.</span><span class="n">getSPHParticleVec</span><span class="p">().</span><span class="n">size</span><span class="p">(),</span> <span class="mi">200</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The test can be written in the standard way and numerous examples can be found on the web.
Of course, we have to be careful about keeping in mind that the test will be run
on two processes in this particular case.</p>

<h5 id="caveat">Caveat</h5>
<p>The <code class="language-plaintext highlighter-rouge">Boost</code> MPI environment created by
<a href="http://www.boost.org/docs/libs/1_50_0/boost/mpi/environment.hpp"><code class="language-plaintext highlighter-rouge">boost::mpi::environment</code></a>
allows MPI calls to
fail without throwing an exception.  For example, in my <code class="language-plaintext highlighter-rouge">Patch</code> code discussed in
an earlier article, I have</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">MPI_Cart_rank</span><span class="p">(</span><span class="n">cartComm</span><span class="p">,</span> <span class="n">neighborCoords</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">neighborRank</span><span class="p">);</span></code></pre></figure>

<p>I deliberately send invalid <code class="language-plaintext highlighter-rouge">neighborCoords</code> to this function to find out if a patch
is a boundary patch.  This does not create a problem when I use the <code class="language-plaintext highlighter-rouge">boost::mpi::environment</code>
set up.  But when setting up the environment explicitly for the unit tests, I have
to add</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">MPI_Errhandler_set</span><span class="p">(</span><span class="n">cartComm</span><span class="p">,</span> <span class="n">MPI_ERRORS_RETURN</span><span class="p">);</span></code></pre></figure>

<p>before I call <code class="language-plaintext highlighter-rouge">MPI_Cart_rank</code> to make sure I don’t get errors when I use invalid
values of <code class="language-plaintext highlighter-rouge">neighborCoords</code>.</p>

<h4 id="the-output-from-make">The output from make</h4>
<p>Now, if we run <code class="language-plaintext highlighter-rouge">make</code> (after setting up the makefiles with cmake, of course),
we not only compile the code but also run the unit test!  In this particular case,
here’s what the output looks like:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">[</span> 69%] Built target ellip3D_lib
<span class="o">[</span> 71%] Built target paraEllip3D
<span class="o">[</span> 74%] Built target gtest
<span class="o">[</span> 76%] Built target gtest_main
.......
Scanning dependencies of target testSPHParticleScatter
<span class="o">[</span> 90%] Building CXX object SmoothParticleHydro/UnitTests/CMakeFiles/testSPHParticleScatter.dir/testSPHParticleScatter.cpp.o
<span class="o">[</span> 91%] Linking CXX executable testSPHParticleScatter
<span class="o">[==========]</span> Running 1 <span class="nb">test </span>from 1 <span class="nb">test </span><span class="k">case</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------</span><span class="o">]</span> Global <span class="nb">test </span>environment set-up.
<span class="o">[==========]</span> Running 1 <span class="nb">test </span>from 1 <span class="nb">test </span><span class="k">case</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------</span><span class="o">]</span> Global <span class="nb">test </span>environment set-up.
Set up environment
Set up environment
<span class="o">[</span><span class="nt">----------</span><span class="o">]</span> 1 <span class="nb">test </span>from SPHParticleScatterTest
<span class="o">[</span><span class="nt">----------</span><span class="o">]</span> 1 <span class="nb">test </span>from SPHParticleScatterTest
<span class="o">[</span> RUN      <span class="o">]</span> SPHParticleScatterTest.scatter
<span class="o">[</span> RUN      <span class="o">]</span> SPHParticleScatterTest.scatter
<span class="o">[</span>       OK <span class="o">]</span> SPHParticleScatterTest.scatter <span class="o">(</span>5 ms<span class="p">)</span>
<span class="o">[</span><span class="nt">----------</span><span class="o">]</span> 1 <span class="nb">test </span>from SPHParticleScatterTest <span class="o">(</span>5 ms total<span class="o">)</span>

<span class="o">[</span><span class="nt">----------</span><span class="o">]</span> Global <span class="nb">test </span>environment tear-down
<span class="o">[</span>       OK <span class="o">]</span> SPHParticleScatterTest.scatter <span class="o">(</span>6 ms<span class="o">)</span>
<span class="o">[</span><span class="nt">----------</span><span class="o">]</span> 1 <span class="nb">test </span>from SPHParticleScatterTest <span class="o">(</span>6 ms total<span class="o">)</span>

<span class="o">[</span><span class="nt">----------</span><span class="o">]</span> Global <span class="nb">test </span>environment tear-down
Tore down environment
<span class="o">[==========]</span> 1 <span class="nb">test </span>from 1 <span class="nb">test </span><span class="k">case</span> ran. <span class="o">(</span>289 ms total<span class="p">)</span>
<span class="o">[</span>  PASSED  <span class="o">]</span> 1 test.
Tore down environment
<span class="o">[==========]</span> 1 <span class="nb">test </span>from 1 <span class="nb">test </span><span class="k">case</span> ran. <span class="o">(</span>289 ms total<span class="p">)</span>
<span class="o">[</span>  PASSED  <span class="o">]</span> 1 test.
<span class="o">[</span> 91%] Built target testSPHParticleScatter
<span class="o">[</span> 95%] Built target gmock
<span class="o">[</span>100%] Built target gmock_main</code></pre></figure>

<h4 id="remarks">Remarks</h4>
<p>I hope this article has been of use to you.  Our series on communication between patches
will continue when I get some free time.</p>


        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/ParSim/categories/#c" class="page__taxonomy-item" rel="tag">C++</a><span class="sep">, </span>
    
      
      
      <a href="/ParSim/categories/#mpi" class="page__taxonomy-item" rel="tag">MPI</a>
    
    </span>
  </p>


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-08-11T22:30:00+12:00">August 11, 2017</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Unit+testing+with+MPI%2C+googletest%2C+and+cmake%20https%3A%2F%2Fbbanerjee.github.io%2FParSim%2Fmpi%2Fc%2B%2B%2Fmpi-unit-testing-googletests-cmake%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fbbanerjee.github.io%2FParSim%2Fmpi%2Fc%2B%2B%2Fmpi-unit-testing-googletests-cmake%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fbbanerjee.github.io%2FParSim%2Fmpi%2Fc%2B%2B%2Fmpi-unit-testing-googletests-cmake%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/ParSim/mpi/c++/parallel-domain-decomposition-part-4/" class="pagination--pager" title="Parallel domain decomposition for particle methods: Part 4
">Previous</a>
    
    
      <a href="/ParSim/vaango/compiling-vaango-on-a-cray/" class="pagination--pager" title="Compiling and running the MPM code Vaango on a Cray
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/fem/meshing/gmsh/quadrlateral-meshing-with-gmsh/" rel="permalink">Creating quadrilateral surface meshes with gmsh
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          21 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">The Code-Aster cooling tower modal analysis validation test
FORMA11c comes with a quadrilateral mesh provided by Code-Aster.
Tips on quadrilateral meshing wi...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/fem/cracks/python/salome-meca/code-aster/inspecting-and-manipulating-meshes/" rel="permalink">Inspecting and manipulating meshes in Salome-Meca for Code-Aster
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          30 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">In this article, I will discuss how elements can be selected from deep inside a 3D mesh
in the Salome-Meca environment and manipulated with Python scripts.

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/vaango/compiling-vaango-on-a-cray/" rel="permalink">Compiling and running the MPM code Vaango on a Cray
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          16 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction

One of the reasons I switched to cmake for my builds was the need to compile my
Vaango code on a BlueGene/Q system.  The code was previously co...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ParSim/mpi/c++/parallel-domain-decomposition-part-4/" rel="permalink">Parallel domain decomposition for particle methods: Part 4
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          12 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Introduction
The Plimpton scheme of communicating ghost information between patches was described
in Part 3 of this series.
Let us now see how a similar appr...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
    

    <li><a href="/ParSim/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Biswajit Banerjee. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/ParSim/assets/js/main.min.js"></script>










  </body>
</html>
